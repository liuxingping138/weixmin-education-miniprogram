# 微信小程序教育平台 - 部署指南

## 📋 部署概述

本指南将详细介绍如何将微信小程序教育平台从开发环境部署到生产环境，包括代码准备、配置调整、审核发布等完整流程。

## 🎯 部署前准备

### 1. 环境要求

#### 开发环境
- **微信开发者工具**: >= 1.06.0
- **Node.js**: >= 14.0.0
- **npm**: >= 6.0.0
- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+

#### 生产环境
- **微信小程序平台**: 已注册并认证的小程序账号
- **服务器**: 支持HTTPS的Web服务器（如需后端支持）
- **域名**: 已备案的域名（如需后端支持）
- **SSL证书**: 有效的SSL证书

### 2. 账号准备

#### 微信小程序账号
1. **注册小程序账号**
   - 访问 [微信公众平台](https://mp.weixin.qq.com/)
   - 选择"小程序"类型进行注册
   - 完成邮箱验证和信息登记

2. **完成认证**
   - 提交企业或个人认证资料
   - 支付认证费用（企业300元/年）
   - 等待审核通过

3. **获取AppID**
   - 登录小程序管理后台
   - 在"开发" -> "开发管理" -> "开发设置"中获取AppID

#### 开发者权限
1. **添加开发者**
   - 在"成员管理"中添加开发者
   - 分配相应的权限（开发者权限、体验者权限等）

2. **配置服务器域名**（如需后端支持）
   - 在"开发设置"中配置request合法域名
   - 配置socket合法域名（如需WebSocket）
   - 配置uploadFile合法域名（如需文件上传）
   - 配置downloadFile合法域名（如需文件下载）

## 🔧 代码准备

### 1. 环境配置

#### 更新项目配置
```json
// project.config.json
{
  "appid": "你的小程序AppID",
  "projectname": "微信小程序教育平台",
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": true,
    "coverView": true,
    "nodeModules": false,
    "autoAudits": true,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "lazyloadPlaceholderEnable": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    },
    "enableEngineNative": false,
    "useIsolateContext": false,
    "userConfirmedBundleSwitch": false,
    "packNpmManually": false,
    "packNpmRelationList": [],
    "minifyWXSS": true,
    "disableUseStrict": false,
    "minifyWXML": true,
    "showES6CompileOption": false,
    "useCompilerPlugins": false
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "condition": {}
}
```

#### 更新应用配置
```json
// app.json
{
  "pages": [
    "pages/index/index",
    "pages/login/login",
    "pages/register/register",
    "pages/homework/homework",
    "pages/class/class",
    "pages/ai/ai",
    "pages/points/points",
    "pages/parent/parent",
    "pages/mistakes/mistakes",
    "pages/courseware/courseware",
    "pages/practice/practice",
    "pages/growth/growth",
    "pages/profile/profile",
    "pages/shop/shop",
    "pages/settings/settings"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#1890ff",
    "navigationBarTitleText": "教育平台",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#f5f5f5"
  },
  "tabBar": {
    "color": "#8c8c8c",
    "selectedColor": "#1890ff",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/tab-home.png",
        "selectedIconPath": "images/tab-home-active.png"
      },
      {
        "pagePath": "pages/homework/homework",
        "text": "作业",
        "iconPath": "images/tab-homework.png",
        "selectedIconPath": "images/tab-homework-active.png"
      },
      {
        "pagePath": "pages/class/class",
        "text": "班级",
        "iconPath": "images/tab-class.png",
        "selectedIconPath": "images/tab-class-active.png"
      },
      {
        "pagePath": "pages/ai/ai",
        "text": "AI助手",
        "iconPath": "images/tab-ai.png",
        "selectedIconPath": "images/tab-ai-active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的",
        "iconPath": "images/tab-profile.png",
        "selectedIconPath": "images/tab-profile-active.png"
      }
    ]
  },
  "permission": {
    "scope.userLocation": {
      "desc": "您的位置信息将用于提供更好的教育服务"
    }
  },
  "requiredBackgroundModes": ["audio"],
  "plugins": {},
  "usingComponents": {
    "t-button": "tdesign-miniprogram/button/button",
    "t-input": "tdesign-miniprogram/input/input",
    "t-cell": "tdesign-miniprogram/cell/cell",
    "t-icon": "tdesign-miniprogram/icon/icon",
    "t-loading": "tdesign-miniprogram/loading/loading",
    "t-toast": "tdesign-miniprogram/toast/toast",
    "t-dialog": "tdesign-miniprogram/dialog/dialog",
    "t-tabs": "tdesign-miniprogram/tabs/tabs",
    "t-tab-panel": "tdesign-miniprogram/tab-panel/tab-panel"
  },
  "sitemapLocation": "sitemap.json",
  "lazyCodeLoading": "requiredComponents"
}
```

### 2. 生产环境配置

#### 关闭Mock数据
```javascript
// utils/mockConfig.js
const mockConfig = {
  enabled: false, // 生产环境关闭Mock
  delay: 0,
  routes: {
    // Mock路由配置保留，但不会被使用
  }
};

module.exports = mockConfig;
```

#### 配置生产API地址
```javascript
// utils/config.js
const config = {
  // 根据环境自动切换API地址
  apiBaseUrl: process.env.NODE_ENV === 'production' 
    ? 'https://api.yourdomain.com' 
    : 'https://dev-api.yourdomain.com',
  
  // 其他配置
  timeout: 10000,
  retryTimes: 3,
  enableLog: process.env.NODE_ENV !== 'production'
};

module.exports = config;
```

#### 更新请求工具
```javascript
// utils/request.js
const config = require('./config');
const mockConfig = require('./mockConfig');

class Request {
  constructor() {
    this.baseURL = config.apiBaseUrl;
    this.timeout = config.timeout;
  }
  
  request(options) {
    return new Promise((resolve, reject) => {
      // 生产环境不使用Mock数据
      if (mockConfig.enabled && mockConfig.routes[options.url]) {
        setTimeout(() => {
          resolve(mockConfig.routes[options.url](options));
        }, mockConfig.delay);
        return;
      }
      
      wx.request({
        url: this.baseURL + options.url,
        method: options.method || 'GET',
        data: options.data,
        timeout: this.timeout,
        header: {
          'Content-Type': 'application/json',
          ...options.header
        },
        success: (res) => {
          if (res.statusCode === 200) {
            resolve(res.data);
          } else {
            reject(new Error(`请求失败: ${res.statusCode}`));
          }
        },
        fail: reject
      });
    });
  }
}

module.exports = new Request();
```

### 3. 代码优化

#### 移除调试代码
```bash
# 使用脚本移除console.log等调试代码
find . -name "*.js" -not -path "./node_modules/*" -exec sed -i '/console\./d' {} \;
```

#### 压缩图片资源
```bash
# 使用imagemin等工具压缩图片
npm install -g imagemin-cli imagemin-pngquant imagemin-mozjpeg

# 压缩PNG图片
imagemin images/*.png --out-dir=images --plugin=pngquant

# 压缩JPG图片
imagemin images/*.jpg --out-dir=images --plugin=mozjpeg
```

#### 代码检查
```bash
# 运行ESLint检查
npm run lint

# 修复可自动修复的问题
npm run lint:fix

# 运行测试
npm run test
```

## 🚀 部署流程

### 1. 开发版本部署

#### 上传代码
1. **打开微信开发者工具**
2. **选择项目目录**
3. **点击"上传"按钮**
4. **填写版本号和项目备注**
   ```
   版本号: 1.0.0
   项目备注: 正式版本，包含完整功能
   ```
5. **点击"上传"完成代码上传**

#### 设置体验版本
1. **登录小程序管理后台**
2. **进入"版本管理"页面**
3. **在"开发版本"中找到刚上传的版本**
4. **点击"选为体验版"**
5. **生成体验版二维码供测试**

### 2. 体验版测试

#### 功能测试清单
- [ ] 用户注册登录功能
- [ ] 作业管理功能
- [ ] 班级管理功能
- [ ] AI助手功能
- [ ] 积分系统功能
- [ ] 家长端功能
- [ ] 错题本功能
- [ ] 课件管理功能
- [ ] 页面跳转和导航
- [ ] 数据存储和同步
- [ ] 网络请求处理
- [ ] 错误处理机制

#### 兼容性测试
- [ ] iOS系统兼容性
- [ ] Android系统兼容性
- [ ] 不同屏幕尺寸适配
- [ ] 不同微信版本兼容性
- [ ] 网络异常处理
- [ ] 性能表现测试

#### 用户体验测试
- [ ] 界面美观度
- [ ] 操作流畅性
- [ ] 响应速度
- [ ] 错误提示友好性
- [ ] 加载状态提示
- [ ] 无障碍访问支持

### 3. 提交审核

#### 审核前检查
1. **完善小程序信息**
   - 小程序名称
   - 小程序简介
   - 小程序头像
   - 服务类目
   - 标签设置

2. **隐私设置**
   - 用户隐私保护指引
   - 数据收集使用说明
   - 第三方SDK使用说明

3. **功能页面设置**
   - 设置小程序的功能页面
   - 配置搜索关键词
   - 设置客服联系方式

#### 提交审核
1. **进入"版本管理"页面**
2. **点击体验版的"提交审核"**
3. **填写审核信息**
   ```
   功能描述: 教育类小程序，提供作业管理、班级管理、AI助手等功能
   测试账号: test@example.com / 123456
   补充说明: 本小程序为教育辅助工具，不涉及付费内容
   ```
4. **选择服务类目**: 教育 -> 在线教育
5. **上传审核材料**（如需要）
6. **提交审核申请**

#### 审核注意事项
- **内容合规**: 确保内容符合微信小程序规范
- **功能完整**: 所有功能都能正常使用
- **用户体验**: 界面友好，操作流畅
- **隐私保护**: 明确说明数据收集和使用方式
- **测试账号**: 提供可用的测试账号和密码

### 4. 发布上线

#### 审核通过后
1. **收到审核通过通知**
2. **进入"版本管理"页面**
3. **点击"发布"按钮**
4. **确认发布信息**
5. **点击"确定"完成发布**

#### 发布后操作
1. **监控线上运行状态**
2. **关注用户反馈**
3. **处理紧急问题**
4. **收集使用数据**

## 📊 监控和维护

### 1. 数据监控

#### 小程序数据助手
- **用户访问数据**: 日活、月活、新增用户等
- **使用行为数据**: 页面访问、功能使用、用户路径等
- **性能数据**: 启动耗时、页面切换耗时等
- **错误数据**: 异常率、错误类型、影响用户数等

#### 自定义数据统计
```javascript
// 埋点统计
function trackEvent(eventName, params = {}) {
  wx.reportAnalytics(eventName, {
    ...params,
    timestamp: Date.now(),
    page: getCurrentPages().pop().route
  });
}

// 使用示例
trackEvent('homework_submit', {
  homework_id: 'hw_001',
  subject: 'math',
  completion_time: 1800 // 秒
});
```

### 2. 错误监控

#### 全局错误处理
```javascript
// app.js
App({
  onError(error) {
    console.error('小程序错误:', error);
    
    // 上报错误信息
    this.reportError({
      error: error.toString(),
      stack: error.stack,
      timestamp: Date.now(),
      version: this.globalData.version,
      systemInfo: wx.getSystemInfoSync()
    });
  },
  
  reportError(errorInfo) {
    wx.request({
      url: 'https://api.yourdomain.com/error-report',
      method: 'POST',
      data: errorInfo,
      fail: (err) => {
        console.error('错误上报失败:', err);
      }
    });
  }
});
```

#### 页面错误处理
```javascript
Page({
  onError(error) {
    console.error('页面错误:', error);
    
    // 显示友好的错误提示
    wx.showToast({
      title: '操作失败，请重试',
      icon: 'none'
    });
  }
});
```

### 3. 性能监控

#### 启动性能监控
```javascript
// app.js
App({
  onLaunch() {
    const startTime = Date.now();
    
    // 应用启动完成后记录耗时
    wx.onAppShow(() => {
      const launchTime = Date.now() - startTime;
      console.log('应用启动耗时:', launchTime);
      
      // 上报启动性能数据
      this.reportPerformance('app_launch', launchTime);
    });
  },
  
  reportPerformance(metric, value) {
    wx.reportAnalytics('performance', {
      metric,
      value,
      timestamp: Date.now()
    });
  }
});
```

#### 页面性能监控
```javascript
Page({
  onLoad() {
    this.loadStartTime = Date.now();
  },
  
  onReady() {
    const loadTime = Date.now() - this.loadStartTime;
    console.log('页面加载耗时:', loadTime);
    
    // 上报页面性能数据
    getApp().reportPerformance('page_load', loadTime);
  }
});
```

### 4. 版本更新

#### 版本更新检测
```javascript
// app.js
App({
  onLaunch() {
    this.checkForUpdate();
  },
  
  checkForUpdate() {
    const updateManager = wx.getUpdateManager();
    
    updateManager.onCheckForUpdate((res) => {
      if (res.hasUpdate) {
        console.log('发现新版本');
      }
    });
    
    updateManager.onUpdateReady(() => {
      wx.showModal({
        title: '更新提示',
        content: '新版本已经准备好，是否重启应用？',
        success: (res) => {
          if (res.confirm) {
            updateManager.applyUpdate();
          }
        }
      });
    });
    
    updateManager.onUpdateFailed(() => {
      console.error('新版本下载失败');
    });
  }
});
```

#### 版本发布流程
1. **开发新功能**
2. **测试验证**
3. **更新版本号**
4. **上传代码**
5. **设置体验版**
6. **内部测试**
7. **提交审核**
8. **发布上线**

## 🔒 安全配置

### 1. 域名配置

#### 服务器域名设置
```
request合法域名:
- https://api.yourdomain.com
- https://cdn.yourdomain.com

uploadFile合法域名:
- https://upload.yourdomain.com

downloadFile合法域名:
- https://download.yourdomain.com

socket合法域名:
- wss://ws.yourdomain.com
```

### 2. 数据安全

#### HTTPS配置
- 所有API接口必须使用HTTPS
- SSL证书必须有效且未过期
- 支持TLS 1.2及以上版本

#### 数据加密
```javascript
// 敏感数据加密
function encryptData(data, key) {
  // 使用AES加密算法
  const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
  return encrypted;
}

// 数据解密
function decryptData(encryptedData, key) {
  const decrypted = CryptoJS.AES.decrypt(encryptedData, key);
  return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
}
```

### 3. 权限控制

#### 用户权限验证
```javascript
// 权限检查中间件
function checkPermission(requiredRole) {
  return function(req, res, next) {
    const userRole = req.user.role;
    
    if (!hasPermission(userRole, requiredRole)) {
      return res.status(403).json({
        code: 403,
        message: '权限不足'
      });
    }
    
    next();
  };
}

// 权限判断
function hasPermission(userRole, requiredRole) {
  const roleHierarchy = {
    'student': 1,
    'teacher': 2,
    'admin': 3
  };
  
  return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}
```

## 📈 运营支持

### 1. 数据分析

#### 关键指标监控
- **用户指标**: DAU、MAU、留存率、流失率
- **功能指标**: 作业完成率、AI使用率、积分获取率
- **性能指标**: 启动时间、页面加载时间、错误率
- **业务指标**: 用户满意度、功能使用深度

#### 数据报表
```javascript
// 生成数据报表
function generateReport(startDate, endDate) {
  return {
    userMetrics: {
      totalUsers: 10000,
      activeUsers: 8000,
      newUsers: 500,
      retentionRate: 0.85
    },
    featureMetrics: {
      homeworkCompletion: 0.92,
      aiUsage: 0.65,
      pointsEarned: 150000
    },
    performanceMetrics: {
      avgLaunchTime: 1200,
      avgPageLoadTime: 800,
      errorRate: 0.01
    }
  };
}
```

### 2. 用户反馈

#### 反馈收集
```javascript
// 用户反馈提交
function submitFeedback(feedback) {
  wx.request({
    url: '/api/feedback',
    method: 'POST',
    data: {
      content: feedback.content,
      type: feedback.type,
      rating: feedback.rating,
      contact: feedback.contact,
      timestamp: Date.now(),
      version: getApp().globalData.version,
      systemInfo: wx.getSystemInfoSync()
    },
    success: () => {
      wx.showToast({
        title: '反馈提交成功',
        icon: 'success'
      });
    }
  });
}
```

#### 客服支持
- **在线客服**: 集成客服消息功能
- **帮助文档**: 提供详细的使用说明
- **FAQ**: 整理常见问题和解答
- **用户社区**: 建立用户交流平台

## 🚨 应急处理

### 1. 紧急修复流程

#### 发现严重问题
1. **立即评估影响范围**
2. **制定修复方案**
3. **开发紧急修复版本**
4. **快速测试验证**
5. **提交紧急审核**
6. **发布修复版本**

#### 紧急回滚
```javascript
// 版本回滚准备
const rollbackPlan = {
  currentVersion: '1.0.1',
  previousVersion: '1.0.0',
  rollbackReason: '严重bug修复',
  rollbackSteps: [
    '1. 下架当前版本',
    '2. 恢复上一版本',
    '3. 通知用户更新',
    '4. 监控系统状态'
  ]
};
```

### 2. 故障处理

#### 服务器故障
- **监控告警**: 设置服务器监控和告警
- **备份方案**: 准备备用服务器和数据备份
- **降级策略**: 关键功能降级方案
- **通信机制**: 建立故障通知机制

#### 数据恢复
```bash
# 数据库备份
mysqldump -u username -p database_name > backup.sql

# 数据恢复
mysql -u username -p database_name < backup.sql
```

## 📋 检查清单

### 部署前检查
- [ ] AppID配置正确
- [ ] 生产环境配置完成
- [ ] Mock数据已关闭
- [ ] 调试代码已移除
- [ ] 图片资源已优化
- [ ] 代码检查通过
- [ ] 功能测试完成
- [ ] 兼容性测试通过
- [ ] 性能测试达标

### 审核前检查
- [ ] 小程序信息完善
- [ ] 隐私政策设置
- [ ] 服务类目正确
- [ ] 测试账号可用
- [ ] 功能描述准确
- [ ] 审核材料齐全

### 发布后检查
- [ ] 线上功能正常
- [ ] 数据监控正常
- [ ] 错误率在正常范围
- [ ] 用户反馈良好
- [ ] 性能指标达标

---

通过遵循这份部署指南，您可以顺利地将微信小程序教育平台部署到生产环境。如有任何问题，请及时联系技术支持团队。