# 教育小程序开发项目规范

## 一、项目概述
本规范适用于教育类微信小程序项目的开发，基于微信小程序原生框架 + TDesign Weapp UI库 + FastAPI后端的技术栈。

---

## 二、项目结构规范

### 2.1 前端小程序目录结构
```
edu-miniprogram/
├── app.js                    # 小程序入口文件
├── app.json                  # 小程序全局配置
├── app.wxss                  # 小程序全局样式
├── sitemap.json              # 小程序搜索配置
├── project.config.json       # 项目配置文件
├── project.private.config.json # 私有配置文件
├── pages/                    # 页面目录
│   ├── index/               # 首页
│   │   ├── index.js
│   │   ├── index.json
│   │   ├── index.wxml
│   │   └── index.wxss
│   ├── auth/                # 认证相关页面
│   │   ├── login/
│   │   └── register/
│   ├── dashboard/           # 数据仪表盘
│   ├── class/               # 班级管理
│   ├── homework/            # 作业系统
│   ├── store/               # 积分商城
│   ├── profile/             # 个人中心
│   └── growth/              # 学生成长
├── components/              # 自定义组件
│   ├── chart/               # 图表组件
│   ├── homework-item/       # 作业项组件
│   ├── student-card/        # 学生卡片组件
│   └── common/              # 通用组件
├── utils/                   # 工具函数
│   ├── request.js           # 网络请求封装
│   ├── storage.js           # 本地存储封装
│   ├── auth.js              # 认证相关工具
│   ├── format.js            # 数据格式化工具
│   └── constants.js         # 常量定义
├── assets/                  # 静态资源
│   ├── images/              # 图片资源
│   ├── icons/               # 图标资源
│   └── fonts/               # 字体资源
├── styles/                  # 样式文件
│   ├── variables.wxss       # 样式变量
│   ├── mixins.wxss          # 样式混入
│   └── common.wxss          # 通用样式
└── libs/                    # 第三方库
    ├── tdesign/             # TDesign组件库
    └── echarts/             # ECharts图表库
```

### 2.2 后端项目目录结构
```
edu-backend/
├── main.py                  # FastAPI应用入口
├── requirements.txt         # Python依赖
├── .env                     # 环境变量配置
├── .env.example             # 环境变量示例
├── app/
│   ├── __init__.py
│   ├── config.py            # 配置文件
│   ├── database.py          # 数据库连接
│   ├── dependencies.py      # 依赖注入
│   ├── models/              # 数据模型
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── class_model.py
│   │   ├── homework.py
│   │   ├── store.py
│   │   └── growth.py
│   ├── schemas/             # Pydantic模式
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── class_schema.py
│   │   ├── homework.py
│   │   ├── store.py
│   │   └── growth.py
│   ├── api/                # API路由
│   │   ├── __init__.py
│   │   ├── auth.py
│   │   ├── users.py
│   │   ├── classes.py
│   │   ├── homework.py
│   │   ├── store.py
│   │   └── growth.py
│   ├── services/           # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── auth_service.py
│   │   ├── class_service.py
│   │   ├── homework_service.py
│   │   ├── store_service.py
│   │   └── ai_service.py
│   ├── utils/              # 工具函数
│   │   ├── __init__.py
│   │   ├── security.py     # 安全相关
│   │   ├── jwt.py          # JWT处理
│   │   ├── validators.py   # 数据验证
│   │   └── helpers.py      # 辅助函数
│   └── tests/              # 测试文件
│       ├── __init__.py
│       ├── test_auth.py
│       ├── test_classes.py
│       └── test_homework.py
├── alembic/                # 数据库迁移
│   ├── versions/
│   ├── env.py
│   └── alembic.ini
├── docs/                   # 文档
│   ├── api.md
│   └── deployment.md
└── scripts/                # 脚本文件
    ├── init_db.py
    └── seed_data.py
```

---

## 三、开发规范

### 3.1 命名规范

#### 3.1.1 文件命名
- **页面文件**：使用小写字母和连字符，如 `class-management.js`
- **组件文件**：使用小写字母和连字符，如 `student-card.js`
- **工具文件**：使用小写字母和连字符，如 `request-utils.js`
- **样式文件**：使用小写字母和连字符，如 `common-styles.wxss`

#### 3.1.2 变量命名
- **JavaScript变量**：使用驼峰命名法，如 `studentInfo`、`homeworkList`
- **常量**：使用大写字母和下划线，如 `API_BASE_URL`、`MAX_UPLOAD_SIZE`
- **CSS类名**：使用BEM命名法，如 `.student-card__header`、`.homework-item--completed`

#### 3.1.3 函数命名
- **事件处理函数**：以 `on` 或 `handle` 开头，如 `onSubmitHomework`、`handleUserLogin`
- **工具函数**：使用动词开头，如 `formatDate`、`validateForm`
- **API函数**：使用RESTful风格，如 `getStudentList`、`createHomework`

### 3.2 代码规范

#### 3.2.1 JavaScript规范
```javascript
// 使用const和let，避免使用var
const API_BASE_URL = 'https://api.example.com';
let currentUser = null;

// 函数声明
function formatStudentScore(score) {
  if (typeof score !== 'number') {
    throw new Error('Score must be a number');
  }
  return Math.round(score * 100) / 100;
}

// 对象解构
const { name, age, grade } = studentInfo;

// 模板字符串
const message = `学生 ${name} 的成绩是 ${score} 分`;

// 异步处理
async function fetchHomeworkList(classId) {
  try {
    const response = await request.get(`/api/homework?class_id=${classId}`);
    return response.data;
  } catch (error) {
    console.error('获取作业列表失败:', error);
    throw error;
  }
}
```

#### 3.2.2 WXML规范
```xml
<!-- 使用语义化标签 -->
<view class="student-card">
  <view class="student-card__header">
    <text class="student-card__name">{{student.name}}</text>
    <text class="student-card__score">{{student.score}}分</text>
  </view>
  <view class="student-card__content">
    <text class="student-card__description">{{student.description}}</text>
  </view>
</view>

<!-- 条件渲染 -->
<view wx:if="{{homeworkList.length > 0}}" class="homework-list">
  <view wx:for="{{homeworkList}}" wx:key="id" class="homework-item">
    <text>{{item.title}}</text>
  </view>
</view>
<view wx:else class="empty-state">
  <text>暂无作业</text>
</view>
```

#### 3.2.3 WXSS规范
```css
/* 使用CSS变量 */
:root {
  --primary-color: #1890ff;
  --success-color: #52c41a;
  --warning-color: #faad14;
  --error-color: #f5222d;
  --text-color: #333333;
  --border-color: #d9d9d9;
}

/* BEM命名法 */
.student-card {
  padding: 32rpx;
  margin: 16rpx;
  border-radius: 16rpx;
  background-color: #ffffff;
  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.1);
}

.student-card__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16rpx;
}

.student-card__name {
  font-size: 32rpx;
  font-weight: 600;
  color: var(--text-color);
}

.student-card__score {
  font-size: 28rpx;
  color: var(--primary-color);
}

/* 响应式设计 */
@media (max-width: 750rpx) {
  .student-card {
    margin: 8rpx;
    padding: 24rpx;
  }
}
```

### 3.3 组件开发规范

#### 3.3.1 组件结构
```javascript
// components/student-card/student-card.js
Component({
  properties: {
    student: {
      type: Object,
      value: {},
      observer: function(newVal, oldVal) {
        // 属性变化监听
        this.updateStudentInfo(newVal);
      }
    },
    showScore: {
      type: Boolean,
      value: true
    }
  },

  data: {
    formattedScore: ''
  },

  lifetimes: {
    attached() {
      // 组件实例进入页面节点树时执行
      this.initComponent();
    },
    detached() {
      // 组件实例被从页面节点树移除时执行
      this.cleanup();
    }
  },

  methods: {
    initComponent() {
      this.updateStudentInfo(this.data.student);
    },

    updateStudentInfo(student) {
      if (student && student.score !== undefined) {
        this.setData({
          formattedScore: this.formatScore(student.score)
        });
      }
    },

    formatScore(score) {
      return Math.round(score * 100) / 100 + '分';
    },

    onTapCard() {
      this.triggerEvent('cardtap', {
        student: this.data.student
      });
    },

    cleanup() {
      // 清理工作
    }
  }
});
```

---

## 四、API接口规范

### 4.1 请求规范
```javascript
// utils/request.js
const request = {
  baseURL: 'https://api.example.com',
  
  // 通用请求方法
  async request(options) {
    const { url, method = 'GET', data, header = {} } = options;
    
    // 添加认证头
    const token = wx.getStorageSync('token');
    if (token) {
      header['Authorization'] = `Bearer ${token}`;
    }
    
    try {
      const response = await new Promise((resolve, reject) => {
        wx.request({
          url: this.baseURL + url,
          method,
          data,
          header: {
            'Content-Type': 'application/json',
            ...header
          },
          success: resolve,
          fail: reject
        });
      });
      
      // 统一处理响应
      if (response.statusCode === 200) {
        const result = response.data;
        if (result.code === 200) {
          return result;
        } else {
          throw new Error(result.message || '请求失败');
        }
      } else if (response.statusCode === 401) {
        // Token过期，跳转登录
        wx.removeStorageSync('token');
        wx.navigateTo({ url: '/pages/auth/login/login' });
        throw new Error('登录已过期');
      } else {
        throw new Error(`请求失败: ${response.statusCode}`);
      }
    } catch (error) {
      console.error('请求错误:', error);
      wx.showToast({
        title: error.message || '网络错误',
        icon: 'none'
      });
      throw error;
    }
  },
  
  get(url, params) {
    const queryString = params ? '?' + Object.keys(params)
      .map(key => `${key}=${encodeURIComponent(params[key])}`)
      .join('&') : '';
    return this.request({ url: url + queryString, method: 'GET' });
  },
  
  post(url, data) {
    return this.request({ url, method: 'POST', data });
  },
  
  put(url, data) {
    return this.request({ url, method: 'PUT', data });
  },
  
  delete(url) {
    return this.request({ url, method: 'DELETE' });
  }
};

module.exports = request;
```

### 4.2 API调用示例
```javascript
// services/homework-service.js
const request = require('../utils/request');

class HomeworkService {
  // 获取作业列表
  static async getHomeworkList(classId, page = 1, pageSize = 10) {
    return await request.get('/api/homework', {
      class_id: classId,
      page,
      page_size: pageSize
    });
  }
  
  // 提交作业
  static async submitHomework(homeworkId, answers) {
    return await request.post(`/api/homework/${homeworkId}/submit`, {
      answers
    });
  }
  
  // 获取作业统计
  static async getHomeworkStats(homeworkId) {
    return await request.get(`/api/homework/${homeworkId}/stats`);
  }
}

module.exports = HomeworkService;
```

---

## 五、状态管理规范

### 5.1 全局状态管理
```javascript
// utils/store.js
class Store {
  constructor() {
    this.state = {
      user: null,
      currentClass: null,
      homeworkList: [],
      loading: false
    };
    this.listeners = [];
  }
  
  // 获取状态
  getState() {
    return { ...this.state };
  }
  
  // 更新状态
  setState(newState) {
    this.state = { ...this.state, ...newState };
    this.notify();
  }
  
  // 订阅状态变化
  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      const index = this.listeners.indexOf(listener);
      if (index > -1) {
        this.listeners.splice(index, 1);
      }
    };
  }
  
  // 通知监听器
  notify() {
    this.listeners.forEach(listener => listener(this.state));
  }
}

const store = new Store();
module.exports = store;
```

### 5.2 页面状态管理
```javascript
// pages/homework/homework.js
const store = require('../../utils/store');
const HomeworkService = require('../../services/homework-service');

Page({
  data: {
    homeworkList: [],
    loading: false,
    currentClass: null
  },
  
  onLoad() {
    // 订阅全局状态
    this.unsubscribe = store.subscribe((state) => {
      this.setData({
        currentClass: state.currentClass,
        loading: state.loading
      });
    });
    
    this.loadHomeworkList();
  },
  
  onUnload() {
    // 取消订阅
    if (this.unsubscribe) {
      this.unsubscribe();
    }
  },
  
  async loadHomeworkList() {
    try {
      store.setState({ loading: true });
      const result = await HomeworkService.getHomeworkList(
        store.getState().currentClass?.id
      );
      this.setData({ homeworkList: result.data });
      store.setState({ homeworkList: result.data });
    } catch (error) {
      console.error('加载作业列表失败:', error);
    } finally {
      store.setState({ loading: false });
    }
  }
});
```

---

## 六、错误处理规范

### 6.1 全局错误处理
```javascript
// app.js
App({
  onLaunch() {
    // 全局错误监听
    wx.onError((error) => {
      console.error('小程序错误:', error);
      // 上报错误到服务器
      this.reportError(error);
    });
    
    // 未处理的Promise拒绝
    wx.onUnhandledRejection((res) => {
      console.error('未处理的Promise拒绝:', res);
      this.reportError(res.reason);
    });
  },
  
  reportError(error) {
    // 错误上报逻辑
    wx.request({
      url: 'https://api.example.com/api/errors',
      method: 'POST',
      data: {
        error: error.toString(),
        stack: error.stack,
        timestamp: Date.now(),
        userAgent: wx.getSystemInfoSync()
      }
    });
  }
});
```

### 6.2 页面错误处理
```javascript
// 错误边界组件
Component({
  methods: {
    onError(error) {
      console.error('组件错误:', error);
      this.setData({
        hasError: true,
        errorMessage: '组件加载失败，请重试'
      });
    },
    
    onRetry() {
      this.setData({
        hasError: false,
        errorMessage: ''
      });
      this.triggerEvent('retry');
    }
  }
});
```

---

## 七、性能优化规范

### 7.1 图片优化
```javascript
// 图片懒加载组件
Component({
  properties: {
    src: String,
    lazyLoad: {
      type: Boolean,
      value: true
    }
  },
  
  data: {
    loaded: false,
    error: false
  },
  
  methods: {
    onImageLoad() {
      this.setData({ loaded: true });
    },
    
    onImageError() {
      this.setData({ error: true });
    }
  }
});
```

### 7.2 数据缓存
```javascript
// utils/cache.js
class Cache {
  constructor() {
    this.cache = new Map();
    this.expireTime = new Map();
  }
  
  set(key, value, ttl = 300000) { // 默认5分钟过期
    this.cache.set(key, value);
    this.expireTime.set(key, Date.now() + ttl);
  }
  
  get(key) {
    if (this.isExpired(key)) {
      this.delete(key);
      return null;
    }
    return this.cache.get(key);
  }
  
  isExpired(key) {
    const expireTime = this.expireTime.get(key);
    return expireTime && Date.now() > expireTime;
  }
  
  delete(key) {
    this.cache.delete(key);
    this.expireTime.delete(key);
  }
  
  clear() {
    this.cache.clear();
    this.expireTime.clear();
  }
}

const cache = new Cache();
module.exports = cache;
```

---

## 八、测试规范

### 8.1 单元测试
```javascript
// tests/utils/format.test.js
const { formatScore, formatDate } = require('../../utils/format');

describe('格式化工具测试', () => {
  test('分数格式化', () => {
    expect(formatScore(85.678)).toBe('85.68分');
    expect(formatScore(100)).toBe('100分');
    expect(formatScore(0)).toBe('0分');
  });
  
  test('日期格式化', () => {
    const date = new Date('2025-01-01 12:30:45');
    expect(formatDate(date)).toBe('2025-01-01 12:30');
  });
});
```

### 8.2 集成测试
```javascript
// tests/services/homework.test.js
const HomeworkService = require('../../services/homework-service');

describe('作业服务测试', () => {
  test('获取作业列表', async () => {
    const result = await HomeworkService.getHomeworkList(1);
    expect(result.code).toBe(200);
    expect(Array.isArray(result.data)).toBe(true);
  });
  
  test('提交作业', async () => {
    const answers = { '1': 'A', '2': 'B' };
    const result = await HomeworkService.submitHomework(1, answers);
    expect(result.code).toBe(200);
  });
});
```

---

## 九、Git规范

### 9.1 分支管理
- **main**: 主分支，用于生产环境
- **develop**: 开发分支，用于集成开发
- **feature/xxx**: 功能分支，用于开发新功能
- **hotfix/xxx**: 热修复分支，用于紧急修复
- **release/xxx**: 发布分支，用于发布准备

### 9.2 提交规范
```bash
# 提交格式
<type>(<scope>): <subject>

<body>

<footer>

# 示例
feat(homework): 添加作业提交功能

- 实现作业答案提交接口
- 添加提交状态验证
- 优化提交成功提示

Closes #123
```

### 9.3 提交类型
- **feat**: 新功能
- **fix**: 修复bug
- **docs**: 文档更新
- **style**: 代码格式调整
- **refactor**: 代码重构
- **test**: 测试相关
- **chore**: 构建过程或辅助工具的变动

---

## 十、部署规范

### 10.1 环境配置
```javascript
// config/env.js
const env = {
  development: {
    API_BASE_URL: 'https://dev-api.example.com',
    DEBUG: true,
    LOG_LEVEL: 'debug'
  },
  production: {
    API_BASE_URL: 'https://api.example.com',
    DEBUG: false,
    LOG_LEVEL: 'error'
  }
};

module.exports = env[process.env.NODE_ENV || 'development'];
```

### 10.2 构建脚本
```json
{
  "scripts": {
    "dev": "cross-env NODE_ENV=development npm run build:dev",
    "build": "cross-env NODE_ENV=production npm run build:prod",
    "build:dev": "webpack --config webpack.dev.js",
    "build:prod": "webpack --config webpack.prod.js",
    "test": "jest",
    "lint": "eslint src/",
    "preview": "npm run build && miniprogram-ci preview",
    "upload": "npm run build && miniprogram-ci upload"
  }
}
```

---

## 十一、安全规范

### 11.1 数据安全
```javascript
// 敏感数据加密
const crypto = require('crypto');

function encryptData(data, key) {
  const cipher = crypto.createCipher('aes192', key);
  let encrypted = cipher.update(data, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return encrypted;
}

function decryptData(encryptedData, key) {
  const decipher = crypto.createDecipher('aes192', key);
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

### 11.2 输入验证
```javascript
// 输入验证工具
const validator = {
  isEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  },
  
  isPhone(phone) {
    const phoneRegex = /^1[3-9]\d{9}$/;
    return phoneRegex.test(phone);
  },
  
  sanitizeInput(input) {
    return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                .replace(/<[^>]+>/g, '')
                .trim();
  }
};
```

---

## 十二、文档规范

### 12.1 代码注释
```javascript
/**
 * 格式化学生成绩
 * @param {number} score - 原始分数
 * @param {number} precision - 小数位数，默认为2
 * @returns {string} 格式化后的分数字符串
 * @example
 * formatScore(85.678, 2) // returns "85.68分"
 */
function formatScore(score, precision = 2) {
  if (typeof score !== 'number') {
    throw new Error('Score must be a number');
  }
  return Math.round(score * Math.pow(10, precision)) / Math.pow(10, precision) + '分';
}
```

### 12.2 README文档
```markdown
# 教育小程序

## 项目简介
教育类微信小程序，提供教学管理、课堂互动、学习评估等功能。

## 技术栈
- 前端：微信小程序原生框架 + TDesign Weapp
- 后端：Python + FastAPI
- 数据库：MySQL
- 部署：微信云托管

## 快速开始
1. 克隆项目
2. 安装依赖
3. 配置环境变量
4. 启动开发服务器

## 项目结构
详见项目目录说明

## 开发规范
详见开发规范文档
```

---

## 十三、总结

本规范涵盖了教育小程序开发的各个方面，包括项目结构、代码规范、API设计、状态管理、错误处理、性能优化、测试、Git管理、部署和安全等。

开发团队应严格遵循本规范，确保代码质量和项目的可维护性。规范会根据项目发展和技术更新持续完善。

**最后更新时间**: 2025年1月
**版本**: v1.0
**维护者**: 开发团队