<!--pages/mistakes/mistakes.wxml-->
<view class="mistakes-container">
  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="加载中..." />
  
  <!-- 顶部功能介绍 -->
  <view class="mistakes-header">
    <view class="header-content">
      <view class="title">错题本</view>
      <view class="subtitle">智能分析错题，精准查漏补缺</view>
    </view>
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{mistakeStats.totalCount}}</text>
        <text class="stat-label">错题总数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{mistakeStats.reviewedCount}}</text>
        <text class="stat-label">已复习</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{mistakeStats.masteredCount}}</text>
        <text class="stat-label">已掌握</text>
      </view>
    </view>
  </view>

  <!-- 功能导航 -->
  <view class="mistakes-nav">
    <view 
      class="nav-item {{activeTab === 'list' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="list"
    >
      <text>错题列表</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'analysis' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="analysis"
    >
      <text>错题分析</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'review' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="review"
    >
      <text>复习计划</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'practice' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="practice"
    >
      <text>专项练习</text>
    </view>
  </view>

  <!-- 标签页内容 -->
  <view class="tab-content">
    <!-- 错题列表 -->
    <view wx:if="{{activeTab === 'list'}}" class="list-content">
      <!-- 筛选器 -->
      <view class="filter-bar">
        <view class="filter-item">
          <text class="filter-label">学科</text>
          <picker 
            mode="selector" 
            range="{{subjectFilter}}" 
            range-key="name"
            value="{{selectedSubjectFilter}}"
            bindchange="onSubjectFilterChange"
          >
            <view class="picker-value">{{subjectFilter[selectedSubjectFilter].name}}</view>
          </picker>
        </view>
        <view class="filter-item">
          <text class="filter-label">状态</text>
          <picker 
            mode="selector" 
            range="{{statusFilter}}" 
            range-key="name"
            value="{{selectedStatusFilter}}"
            bindchange="onStatusFilterChange"
          >
            <view class="picker-value">{{statusFilter[selectedStatusFilter].name}}</view>
          </picker>
        </view>
        <view class="filter-item">
          <text class="filter-label">排序</text>
          <picker 
            mode="selector" 
            range="{{sortOptions}}" 
            range-key="name"
            value="{{selectedSort}}"
            bindchange="onSortChange"
          >
            <view class="picker-value">{{sortOptions[selectedSort].name}}</view>
          </picker>
        </view>
      </view>

      <!-- 错题列表 -->
      <view class="mistakes-list">
        <view 
          wx:for="{{mistakesList}}"
          wx:key="id"
          class="mistake-card"
          bindtap="viewMistakeDetail"
          data-mistake="{{item}}"
        >
          <view class="card-header">
            <view class="subject-tag {{item.subject}}">{{item.subjectName}}</view>
            <view class="status-tag {{item.status}}">{{item.statusText}}</view>
            <view class="difficulty-tag {{item.difficulty}}">{{item.difficultyText}}</view>
          </view>
          <view class="question-content">
            <view class="question-text">{{item.questionText}}</view>
            <view class="question-images" wx:if="{{item.images && item.images.length > 0}}">
              <image 
                wx:for="{{item.images}}"
                wx:key="*this"
                wx:for-item="img"
                src="{{img}}"
                class="question-image"
                mode="aspectFit"
                bindtap="previewImage"
                data-src="{{img}}"
                data-urls="{{item.images}}"
              />
            </view>
          </view>
          <view class="mistake-info">
            <view class="info-item">
              <text class="info-label">错误次数</text>
              <text class="info-value error-count">{{item.errorCount}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">最近错误</text>
              <text class="info-value">{{item.lastErrorTime}}</text>
            </view>
            <view class="info-item" wx:if="{{item.reviewCount > 0}}">
              <text class="info-label">复习次数</text>
              <text class="info-value">{{item.reviewCount}}</text>
            </view>
          </view>
          <view class="card-actions">
            <t-button 
              theme="light" 
              size="small" 
              bindtap="addToReview"
              data-id="{{item.id}}"
              catch:tap="true"
            >
              加入复习
            </t-button>
            <t-button 
              theme="primary" 
              size="small" 
              bindtap="practiceAgain"
              data-id="{{item.id}}"
              catch:tap="true"
            >
              再次练习
            </t-button>
          </view>
        </view>
      </view>

      <!-- 加载更多 -->
      <view class="load-more" wx:if="{{hasMoreMistakes}}">
        <t-button 
          theme="light" 
          size="medium" 
          loading="{{loadingMore}}"
          bindtap="loadMoreMistakes"
        >
          {{loadingMore ? '加载中...' : '加载更多'}}
        </t-button>
      </view>
    </view>

    <!-- 错题分析 -->
    <view wx:if="{{activeTab === 'analysis'}}" class="analysis-content">
      <!-- 学科分布 -->
      <view class="analysis-section">
        <view class="section-title">学科分布</view>
        <view class="subject-distribution">
          <view 
            wx:for="{{subjectDistribution}}"
            wx:key="subject"
            class="distribution-item"
          >
            <view class="subject-info">
              <view class="subject-name">{{item.subjectName}}</view>
              <view class="subject-count">{{item.count}}题</view>
            </view>
            <view class="progress-bar">
              <view 
                class="progress-fill {{item.subject}}"
                style="width: {{item.percentage}}%"
              ></view>
            </view>
            <view class="percentage">{{item.percentage}}%</view>
          </view>
        </view>
      </view>

      <!-- 知识点分析 -->
      <view class="analysis-section">
        <view class="section-title">薄弱知识点</view>
        <view class="knowledge-analysis">
          <view 
            wx:for="{{weakKnowledgePoints}}"
            wx:key="id"
            class="knowledge-item"
            bindtap="practiceKnowledgePoint"
            data-point="{{item}}"
          >
            <view class="knowledge-header">
              <view class="knowledge-name">{{item.name}}</view>
              <view class="error-rate">错误率 {{item.errorRate}}%</view>
            </view>
            <view class="knowledge-stats">
              <text class="stat">错题{{item.errorCount}}道</text>
              <text class="stat">涉及{{item.questionCount}}题</text>
            </view>
            <view class="knowledge-suggestion">
              <text class="suggestion-text">{{item.suggestion}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 错误趋势 -->
      <view class="analysis-section">
        <view class="section-title">错误趋势</view>
        <view class="trend-chart">
          <canvas 
            canvas-id="trendChart" 
            class="chart-canvas"
            bindtouchstart="onChartTouchStart"
            bindtouchmove="onChartTouchMove"
            bindtouchend="onChartTouchEnd"
          ></canvas>
        </view>
        <view class="trend-summary">
          <view class="summary-item">
            <text class="summary-label">本周错题</text>
            <text class="summary-value">{{trendData.weekCount}}道</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">环比上周</text>
            <text class="summary-value {{trendData.weekChange >= 0 ? 'increase' : 'decrease'}}">
              {{trendData.weekChange >= 0 ? '+' : ''}}{{trendData.weekChange}}%
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- 复习计划 -->
    <view wx:if="{{activeTab === 'review'}}" class="review-content">
      <!-- 复习统计 -->
      <view class="review-stats">
        <view class="stats-card">
          <view class="stats-title">今日复习</view>
          <view class="stats-content">
            <text class="stats-number">{{reviewStats.todayCount}}</text>
            <text class="stats-unit">题</text>
          </view>
          <view class="stats-progress">
            <view class="progress-bar">
              <view 
                class="progress-fill"
                style="width: {{reviewStats.todayProgress}}%"
              ></view>
            </view>
            <text class="progress-text">{{reviewStats.todayProgress}}%</text>
          </view>
        </view>
        <view class="stats-card">
          <view class="stats-title">本周复习</view>
          <view class="stats-content">
            <text class="stats-number">{{reviewStats.weekCount}}</text>
            <text class="stats-unit">题</text>
          </view>
          <view class="stats-target">
            <text class="target-text">目标: {{reviewStats.weekTarget}}题</text>
          </view>
        </view>
      </view>

      <!-- 复习计划列表 -->
      <view class="review-plans">
        <view class="section-title">复习计划</view>
        <view 
          wx:for="{{reviewPlans}}"
          wx:key="id"
          class="plan-card"
        >
          <view class="plan-header">
            <view class="plan-title">{{item.title}}</view>
            <view class="plan-status {{item.status}}">{{item.statusText}}</view>
          </view>
          <view class="plan-info">
            <view class="info-row">
              <text class="info-label">复习时间</text>
              <text class="info-value">{{item.reviewTime}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">题目数量</text>
              <text class="info-value">{{item.questionCount}}题</text>
            </view>
            <view class="info-row">
              <text class="info-label">预计用时</text>
              <text class="info-value">{{item.estimatedTime}}分钟</text>
            </view>
          </view>
          <view class="plan-progress" wx:if="{{item.status === 'in_progress'}}">
            <view class="progress-bar">
              <view 
                class="progress-fill"
                style="width: {{item.progress}}%"
              ></view>
            </view>
            <text class="progress-text">{{item.progress}}%</text>
          </view>
          <view class="plan-actions">
            <t-button 
              wx:if="{{item.status === 'pending'}}"
              theme="primary" 
              size="medium" 
              bindtap="startReview"
              data-plan="{{item}}"
            >
              开始复习
            </t-button>
            <t-button 
              wx:if="{{item.status === 'in_progress'}}"
              theme="primary" 
              size="medium" 
              bindtap="continueReview"
              data-plan="{{item}}"
            >
              继续复习
            </t-button>
            <t-button 
              wx:if="{{item.status === 'completed'}}"
              theme="light" 
              size="medium" 
              bindtap="viewReviewResult"
              data-plan="{{item}}"
            >
              查看结果
            </t-button>
          </view>
        </view>
      </view>

      <!-- 创建复习计划 -->
      <view class="create-plan">
        <t-button 
          theme="primary" 
          size="large" 
          bindtap="showCreatePlanDialog"
        >
          创建复习计划
        </t-button>
      </view>
    </view>

    <!-- 专项练习 -->
    <view wx:if="{{activeTab === 'practice'}}" class="practice-content">
      <!-- 练习模式选择 -->
      <view class="practice-modes">
        <view class="section-title">练习模式</view>
        <view class="modes-grid">
          <view 
            wx:for="{{practiceModes}}"
            wx:key="id"
            class="mode-card"
            bindtap="selectPracticeMode"
            data-mode="{{item}}"
          >
            <view class="mode-icon {{item.id}}"></view>
            <view class="mode-name">{{item.name}}</view>
            <view class="mode-desc">{{item.description}}</view>
            <view class="mode-stats">
              <text class="stat">{{item.questionCount}}题</text>
              <text class="stat">{{item.difficulty}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 自定义练习 -->
      <view class="custom-practice">
        <view class="section-title">自定义练习</view>
        <view class="custom-settings">
          <view class="setting-item">
            <text class="setting-label">选择学科</text>
            <view class="subject-selector">
              <view 
                wx:for="{{subjects}}"
                wx:key="id"
                class="subject-option {{selectedPracticeSubjects.indexOf(item.id) > -1 ? 'selected' : ''}}"
                bindtap="togglePracticeSubject"
                data-subject="{{item.id}}"
              >
                {{item.name}}
              </view>
            </view>
          </view>
          <view class="setting-item">
            <text class="setting-label">题目数量</text>
            <view class="quantity-selector">
              <view 
                wx:for="{{[10, 20, 30, 50]}}"
                wx:key="*this"
                class="quantity-option {{practiceQuestionCount === item ? 'selected' : ''}}"
                bindtap="selectPracticeQuestionCount"
                data-count="{{item}}"
              >
                {{item}}题
              </view>
            </view>
          </view>
          <view class="setting-item">
            <text class="setting-label">练习范围</text>
            <view class="range-selector">
              <view 
                wx:for="{{practiceRanges}}"
                wx:key="id"
                class="range-option {{selectedPracticeRange === item.id ? 'selected' : ''}}"
                bindtap="selectPracticeRange"
                data-range="{{item.id}}"
              >
                {{item.name}}
              </view>
            </view>
          </view>
          <t-button 
            theme="primary" 
            size="large" 
            class="start-custom-practice-btn"
            bindtap="startCustomPractice"
            disabled="{{selectedPracticeSubjects.length === 0}}"
          >
            开始练习
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <t-empty 
    wx:if="{{!loading && isEmpty}}"
    icon="search"
    description="暂无错题数据"
  >
    <t-button slot="action" theme="primary" size="medium" bindtap="refreshData">
      刷新数据
    </t-button>
  </t-empty>

  <!-- 创建复习计划弹窗 -->
  <t-popup 
    visible="{{showCreatePlanDialog}}" 
    placement="bottom" 
    bindvisible-change="onCreatePlanDialogChange"
  >
    <view class="create-plan-dialog">
      <view class="dialog-header">
        <text class="dialog-title">创建复习计划</text>
        <view class="dialog-close" bindtap="hideCreatePlanDialog">×</view>
      </view>
      <view class="dialog-content">
        <view class="form-item">
          <text class="form-label">计划名称</text>
          <input 
            class="form-input" 
            placeholder="请输入计划名称"
            value="{{newPlan.title}}"
            bindinput="onPlanTitleInput"
          />
        </view>
        <view class="form-item">
          <text class="form-label">复习时间</text>
          <picker 
            mode="multiSelector" 
            range="{{dateTimeRange}}" 
            value="{{newPlan.dateTime}}"
            bindchange="onPlanDateTimeChange"
          >
            <view class="picker-value">{{newPlan.dateTimeText}}</view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">题目数量</text>
          <view class="quantity-selector">
            <view 
              wx:for="{{[10, 20, 30, 50]}}"
              wx:key="*this"
              class="quantity-option {{newPlan.questionCount === item ? 'selected' : ''}}"
              bindtap="selectNewPlanQuestionCount"
              data-count="{{item}}"
            >
              {{item}}题
            </view>
          </view>
        </view>
      </view>
      <view class="dialog-actions">
        <t-button theme="light" size="medium" bindtap="hideCreatePlanDialog">
          取消
        </t-button>
        <t-button theme="primary" size="medium" bindtap="createReviewPlan">
          创建
        </t-button>
      </view>
    </view>
  </t-popup>

  <!-- Toast提示 -->
  <t-toast id="t-toast" />
</view>