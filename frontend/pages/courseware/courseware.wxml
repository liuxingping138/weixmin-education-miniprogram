<!--pages/courseware/courseware.wxml-->
<view class="courseware-container">
  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="加载中..." />
  
  <!-- 顶部功能介绍 -->
  <view class="header-section">
    <view class="feature-intro">
      <view class="intro-icon">📚</view>
      <view class="intro-content">
        <view class="intro-title">智能课件制作</view>
        <view class="intro-desc">AI驱动的课件生成，让教学更生动有趣</view>
      </view>
    </view>
    
    <!-- 统计信息 -->
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{coursewareStats.totalCourseware}}</view>
        <view class="stat-label">制作课件</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{coursewareStats.animations}}</view>
        <view class="stat-label">动画素材</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{coursewareStats.templates}}</view>
        <view class="stat-label">模板库</view>
      </view>
    </view>
  </view>

  <!-- 功能导航 -->
  <view class="nav-tabs">
    <view 
      class="nav-tab {{activeTab === 'generate' ? 'active' : ''}}"
      data-tab="generate"
      bindtap="switchTab"
    >
      <view class="tab-icon">🎨</view>
      <view class="tab-text">PPT生成</view>
    </view>
    <view 
      class="nav-tab {{activeTab === 'animation' ? 'active' : ''}}"
      data-tab="animation"
      bindtap="switchTab"
    >
      <view class="tab-icon">🎬</view>
      <view class="tab-text">知识动画</view>
    </view>
    <view 
      class="nav-tab {{activeTab === 'library' ? 'active' : ''}}"
      data-tab="library"
      bindtap="switchTab"
    >
      <view class="tab-icon">📖</view>
      <view class="tab-text">课件库</view>
    </view>
  </view>

  <!-- PPT生成页面 -->
  <view class="tab-content" wx:if="{{activeTab === 'generate'}}">
    <!-- 生成配置 -->
    <view class="generate-config">
      <view class="config-section">
        <view class="section-title">
          <view class="title-icon">📋</view>
          <text>课件配置</text>
        </view>
        
        <!-- 科目选择 -->
        <view class="config-item">
          <view class="item-label">选择科目</view>
          <view class="subject-grid">
            <view 
              wx:for="{{subjects}}" 
              wx:key="id"
              class="subject-item {{selectedSubject === item.id ? 'selected' : ''}}"
              data-subject="{{item.id}}"
              bindtap="selectSubject"
            >
              <view class="subject-icon">{{item.icon}}</view>
              <view class="subject-name">{{item.name}}</view>
            </view>
          </view>
        </view>
        
        <!-- 主题输入 -->
        <view class="config-item">
          <view class="item-label">课件主题</view>
          <t-input 
            placeholder="请输入课件主题，如：二次函数的图像与性质"
            value="{{coursewareTitle}}"
            bind:change="onTitleChange"
            maxlength="50"
          />
        </view>
        
        <!-- 内容要点 -->
        <view class="config-item">
          <view class="item-label">内容要点</view>
          <view class="content-points">
            <view 
              wx:for="{{contentPoints}}" 
              wx:key="index"
              class="point-item"
            >
              <t-input 
                placeholder="请输入要点{{index + 1}}"
                value="{{item}}"
                data-index="{{index}}"
                bind:change="onPointChange"
                maxlength="100"
              />
              <view 
                class="point-delete"
                data-index="{{index}}"
                bindtap="deletePoint"
                wx:if="{{contentPoints.length > 1}}"
              >
                ❌
              </view>
            </view>
            <view class="add-point" bindtap="addPoint" wx:if="{{contentPoints.length < 8}}">
              <view class="add-icon">➕</view>
              <text>添加要点</text>
            </view>
          </view>
        </view>
        
        <!-- 模板选择 -->
        <view class="config-item">
          <view class="item-label">选择模板</view>
          <view class="template-grid">
            <view 
              wx:for="{{templates}}" 
              wx:key="id"
              class="template-item {{selectedTemplate === item.id ? 'selected' : ''}}"
              data-template="{{item.id}}"
              bindtap="selectTemplate"
            >
              <view class="template-preview">
                <image src="{{item.preview}}" class="template-image" mode="aspectFit" />
              </view>
              <view class="template-name">{{item.name}}</view>
            </view>
          </view>
        </view>
        
        <!-- 生成按钮 -->
        <view class="generate-actions">
          <t-button 
            theme="primary" 
            size="large"
            loading="{{generating}}"
            disabled="{{!canGenerate}}"
            bind:tap="generateCourseware"
          >
            {{generating ? '生成中...' : '开始生成'}}
          </t-button>
        </view>
      </view>
    </view>
    
    <!-- 生成结果 -->
    <view class="generate-result" wx:if="{{generatedCourseware.length > 0}}">
      <view class="result-header">
        <view class="result-title">
          <view class="title-icon">✨</view>
          <text>生成结果</text>
        </view>
        <view class="result-actions">
          <t-button size="small" theme="light" bind:tap="previewCourseware">
            预览
          </t-button>
          <t-button size="small" theme="primary" bind:tap="downloadCourseware">
            下载
          </t-button>
        </view>
      </view>
      
      <view class="slide-list">
        <view 
          wx:for="{{generatedCourseware}}" 
          wx:key="id"
          class="slide-item"
          data-slide="{{item}}"
          bindtap="viewSlide"
        >
          <view class="slide-preview">
            <image src="{{item.preview}}" class="slide-image" mode="aspectFit" />
          </view>
          <view class="slide-info">
            <view class="slide-title">{{item.title}}</view>
            <view class="slide-desc">{{item.description}}</view>
          </view>
          <view class="slide-number">{{index + 1}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 知识动画页面 -->
  <view class="tab-content" wx:if="{{activeTab === 'animation'}}">
    <!-- 动画分类 -->
    <view class="animation-categories">
      <view class="category-tabs">
        <view 
          wx:for="{{animationCategories}}" 
          wx:key="id"
          class="category-tab {{selectedAnimationCategory === item.id ? 'active' : ''}}"
          data-category="{{item.id}}"
          bindtap="selectAnimationCategory"
        >
          {{item.name}}
        </view>
      </view>
    </view>
    
    <!-- 动画列表 -->
    <view class="animation-list">
      <view 
        wx:for="{{filteredAnimations}}" 
        wx:key="id"
        class="animation-item"
        data-animation="{{item}}"
        bindtap="viewAnimation"
      >
        <view class="animation-preview">
          <image src="{{item.thumbnail}}" class="animation-thumbnail" mode="aspectFit" />
          <view class="play-overlay">
            <view class="play-icon">▶️</view>
          </view>
        </view>
        <view class="animation-info">
          <view class="animation-title">{{item.title}}</view>
          <view class="animation-desc">{{item.description}}</view>
          <view class="animation-meta">
            <view class="meta-item">
              <view class="meta-icon">📚</view>
              <text>{{item.subject}}</text>
            </view>
            <view class="meta-item">
              <view class="meta-icon">⏱️</view>
              <text>{{item.duration}}分钟</text>
            </view>
            <view class="meta-item">
              <view class="meta-icon">👁️</view>
              <text>{{item.views}}</text>
            </view>
          </view>
        </view>
        <view class="animation-actions">
          <t-button 
            size="small" 
            theme="light"
            data-animation="{{item}}"
            bind:tap="collectAnimation"
            catch:tap="true"
          >
            {{item.collected ? '已收藏' : '收藏'}}
          </t-button>
        </view>
      </view>
    </view>
    
    <!-- 空状态 -->
    <t-empty 
      wx:if="{{filteredAnimations.length === 0 && !loading}}"
      icon="search"
      description="暂无相关动画"
    />
  </view>

  <!-- 课件库页面 -->
  <view class="tab-content" wx:if="{{activeTab === 'library'}}">
    <!-- 筛选条件 -->
    <view class="library-filters">
      <view class="filter-row">
        <view class="filter-item">
          <view class="filter-label">科目</view>
          <view class="filter-options">
            <view 
              wx:for="{{librarySubjects}}" 
              wx:key="id"
              class="filter-option {{selectedLibrarySubject === item.id ? 'active' : ''}}"
              data-subject="{{item.id}}"
              bindtap="selectLibrarySubject"
            >
              {{item.name}}
            </view>
          </view>
        </view>
      </view>
      
      <view class="filter-row">
        <view class="filter-item">
          <view class="filter-label">类型</view>
          <view class="filter-options">
            <view 
              wx:for="{{coursewareTypes}}" 
              wx:key="id"
              class="filter-option {{selectedCoursewareType === item.id ? 'active' : ''}}"
              data-type="{{item.id}}"
              bindtap="selectCoursewareType"
            >
              {{item.name}}
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 课件列表 -->
    <view class="courseware-list">
      <view 
        wx:for="{{filteredCourseware}}" 
        wx:key="id"
        class="courseware-item"
        data-courseware="{{item}}"
        bindtap="viewCourseware"
      >
        <view class="courseware-preview">
          <image src="{{item.cover}}" class="courseware-cover" mode="aspectFit" />
          <view class="courseware-badge" wx:if="{{item.isNew}}">
            新
          </view>
        </view>
        <view class="courseware-info">
          <view class="courseware-title">{{item.title}}</view>
          <view class="courseware-desc">{{item.description}}</view>
          <view class="courseware-meta">
            <view class="meta-item">
              <view class="meta-icon">📚</view>
              <text>{{item.subject}}</text>
            </view>
            <view class="meta-item">
              <view class="meta-icon">📄</view>
              <text>{{item.slides}}页</text>
            </view>
            <view class="meta-item">
              <view class="meta-icon">📅</view>
              <text>{{item.createTime}}</text>
            </view>
          </view>
        </view>
        <view class="courseware-actions">
          <t-button 
            size="small" 
            theme="light"
            data-courseware="{{item}}"
            bind:tap="downloadCoursewareItem"
            catch:tap="true"
          >
            下载
          </t-button>
          <t-button 
            size="small" 
            theme="primary"
            data-courseware="{{item}}"
            bind:tap="useCourseware"
            catch:tap="true"
          >
            使用
          </t-button>
        </view>
      </view>
    </view>
    
    <!-- 空状态 -->
    <t-empty 
      wx:if="{{filteredCourseware.length === 0 && !loading}}"
      icon="folder"
      description="暂无相关课件"
    />
  </view>

  <!-- 空状态 -->
  <t-empty 
    wx:if="{{isEmpty && !loading}}"
    icon="data"
    description="暂无数据"
  />

  <!-- Toast提示 -->
  <t-toast 
    visible="{{showToast}}"
    message="{{toastMessage}}"
    bind:close="onToastClose"
  />

  <!-- 动画详情弹窗 -->
  <t-popup 
    visible="{{showAnimationDetail}}"
    placement="bottom"
    bind:visible-change="onAnimationDetailClose"
  >
    <view class="animation-detail" wx:if="{{selectedAnimation}}">
      <view class="detail-header">
        <view class="detail-title">{{selectedAnimation.title}}</view>
        <view class="detail-close" bindtap="closeAnimationDetail">✕</view>
      </view>
      
      <view class="detail-video">
        <video 
          src="{{selectedAnimation.videoUrl}}"
          poster="{{selectedAnimation.thumbnail}}"
          controls
          class="animation-video"
        ></video>
      </view>
      
      <view class="detail-info">
        <view class="info-row">
          <view class="info-label">描述</view>
          <view class="info-value">{{selectedAnimation.description}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">科目</view>
          <view class="info-value">{{selectedAnimation.subject}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">时长</view>
          <view class="info-value">{{selectedAnimation.duration}}分钟</view>
        </view>
        <view class="info-row">
          <view class="info-label">知识点</view>
          <view class="info-value">
            <view 
              wx:for="{{selectedAnimation.knowledgePoints}}" 
              wx:key="*this"
              class="knowledge-tag"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
      
      <view class="detail-actions">
        <t-button 
          theme="light" 
          size="large"
          bind:tap="collectSelectedAnimation"
        >
          {{selectedAnimation.collected ? '取消收藏' : '收藏动画'}}
        </t-button>
        <t-button 
          theme="primary" 
          size="large"
          bind:tap="useAnimation"
        >
          使用动画
        </t-button>
      </view>
    </view>
  </t-popup>

  <!-- 课件详情弹窗 -->
  <t-popup 
    visible="{{showCoursewareDetail}}"
    placement="bottom"
    bind:visible-change="onCoursewareDetailClose"
  >
    <view class="courseware-detail" wx:if="{{selectedCoursewareItem}}">
      <view class="detail-header">
        <view class="detail-title">{{selectedCoursewareItem.title}}</view>
        <view class="detail-close" bindtap="closeCoursewareDetail">✕</view>
      </view>
      
      <view class="detail-preview">
        <image 
          src="{{selectedCoursewareItem.cover}}"
          class="courseware-preview-image"
          mode="aspectFit"
        />
      </view>
      
      <view class="detail-info">
        <view class="info-row">
          <view class="info-label">描述</view>
          <view class="info-value">{{selectedCoursewareItem.description}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">科目</view>
          <view class="info-value">{{selectedCoursewareItem.subject}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">页数</view>
          <view class="info-value">{{selectedCoursewareItem.slides}}页</view>
        </view>
        <view class="info-row">
          <view class="info-label">创建时间</view>
          <view class="info-value">{{selectedCoursewareItem.createTime}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">标签</view>
          <view class="info-value">
            <view 
              wx:for="{{selectedCoursewareItem.tags}}" 
              wx:key="*this"
              class="courseware-tag"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
      
      <view class="detail-actions">
        <t-button 
          theme="light" 
          size="large"
          bind:tap="downloadSelectedCourseware"
        >
          下载课件
        </t-button>
        <t-button 
          theme="primary" 
          size="large"
          bind:tap="useSelectedCourseware"
        >
          立即使用
        </t-button>
      </view>
    </view>
  </t-popup>
</view>