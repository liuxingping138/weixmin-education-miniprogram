<!--pages/points/points.wxml-->
<view class="points-container">
  <!-- é¡¶éƒ¨ç§¯åˆ†ä¿¡æ¯ -->
  <view class="points-header">
    <view class="points-card">
      <view class="points-info">
        <view class="current-points">
          <text class="points-number">{{userPoints.current}}</text>
          <text class="points-unit">ç§¯åˆ†</text>
        </view>
        <view class="points-desc">å½“å‰å¯ç”¨ç§¯åˆ†</view>
        <view class="level-info">
          <text class="level-badge">{{userPoints.levelName}}</text>
          <text class="level-text">Lv.{{userPoints.level}}</text>
        </view>
      </view>
      <view class="points-stats">
        <view class="stat-item">
          <text class="stat-number">{{userPoints.total}}</text>
          <text class="stat-label">ç´¯è®¡è·å¾—</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{userPoints.used}}</text>
          <text class="stat-label">å·²ä½¿ç”¨</text>
        </view>
        <view class="stat-item" bindtap="viewRanking">
          <text class="stat-number">{{userPoints.rank}}</text>
          <text class="stat-label">ç­çº§æ’å</text>
        </view>
      </view>
      <view class="today-earned" wx:if="{{userPoints.todayEarned > 0}}">
        <text class="earned-text">ä»Šæ—¥å·²è·å¾— {{userPoints.todayEarned}} ç§¯åˆ†</text>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½å¯¼èˆª -->
  <view class="function-nav">
    <view class="nav-item {{activeTab === 'mall' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="mall">
      <text class="nav-icon">ğŸ›ï¸</text>
      <text class="nav-text">ç§¯åˆ†å•†åŸ</text>
    </view>
    <view class="nav-item {{activeTab === 'tasks' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="tasks">
      <text class="nav-icon">ğŸ“‹</text>
      <text class="nav-text">ä»»åŠ¡ä¸­å¿ƒ</text>
    </view>
    <view class="nav-item {{activeTab === 'records' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="records">
      <text class="nav-icon">ğŸ“Š</text>
      <text class="nav-text">ç§¯åˆ†è®°å½•</text>
    </view>
    <view class="nav-item {{activeTab === 'ranking' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="ranking">
      <text class="nav-icon">ğŸ†</text>
      <text class="nav-text">æ’è¡Œæ¦œ</text>
    </view>
  </view>

  <!-- ç§¯åˆ†å•†åŸ -->
  <view class="tab-content" wx:if="{{activeTab === 'mall'}}">
    <!-- å•†å“åˆ†ç±» -->
    <view class="category-tabs">
      <scroll-view class="category-scroll" scroll-x="true">
        <view class="category-item {{selectedCategory === 'all' ? 'active' : ''}}" 
              bindtap="selectCategory" data-category="all">
          <text class="category-icon">ğŸ“‹</text>
          <text class="category-name">å…¨éƒ¨</text>
        </view>
        <view class="category-item {{selectedCategory === item.id ? 'active' : ''}}" 
              wx:for="{{categories}}" 
              wx:key="id"
              bindtap="selectCategory" 
              data-category="{{item.id}}">
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.name}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="goods-grid">
      <view class="goods-item" 
            wx:for="{{filteredGoods}}" 
            wx:key="id"
            bindtap="viewGoodsDetail"
            data-goods="{{item}}">
        <view class="goods-image">
          <image src="{{item.image}}" mode="aspectFill" />
          <view class="goods-badge hot" wx:if="{{item.isHot}}">ğŸ”¥ çƒ­é—¨</view>
          <view class="goods-badge new" wx:if="{{item.isNew}}">âœ¨ æ–°å“</view>
          <view class="goods-badge discount" wx:if="{{item.discount > 0}}">{{item.discount}}% OFF</view>
          <view class="goods-stock" wx:if="{{item.stock <= 10 && item.stock > 0}}">ä»…å‰©{{item.stock}}ä»¶</view>
          <view class="goods-sold-out" wx:if="{{item.stock === 0}}">å·²å”®ç½„</view>
        </view>
        <view class="goods-info">
          <view class="goods-name">{{item.name}}</view>
          <view class="goods-desc">{{item.description}}</view>
          <view class="goods-sales">å·²å…‘æ¢ {{item.sales}} ä»¶</view>
          <view class="goods-price">
            <view class="price-info">
              <text class="price-number">{{item.points}}</text>
              <text class="price-unit">ç§¯åˆ†</text>
              <text class="original-price" wx:if="{{item.originalPoints > item.points}}">{{item.originalPoints}}</text>
            </view>
            <view class="exchange-btn" 
                  class="{{item.stock === 0 || userPoints.current < item.points ? 'disabled' : ''}}"
                  bindtap="exchangeGoods"
                  data-goods="{{item}}"
                  catch:tap="true">
              {{item.stock === 0 ? 'å”®ç½„' : userPoints.current < item.points ? 'ç§¯åˆ†ä¸è¶³' : 'å…‘æ¢'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && filteredGoods.length === 0}}">
      <view class="empty-icon">ğŸ›ï¸</view>
      <view class="empty-text">æš‚æ— å•†å“</view>
      <view class="empty-desc">æ•¬è¯·æœŸå¾…æ›´å¤šç²¾å½©å•†å“</view>
    </view>
  </view>

  <!-- ä»»åŠ¡ä¸­å¿ƒ -->
  <view class="tab-content" wx:if="{{activeTab === 'tasks'}}">
    <!-- æ¯æ—¥ä»»åŠ¡ -->
    <view class="task-section">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">ğŸ“… æ¯æ—¥ä»»åŠ¡</text>
          <text class="title-desc">å®Œæˆä»»åŠ¡è·å¾—ç§¯åˆ†å¥–åŠ±</text>
        </view>
        <view class="title-right">
          <text class="refresh-time">æ¯æ—¥0ç‚¹åˆ·æ–°</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item" 
              wx:for="{{dailyTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress" wx:if="{{item.type === 'progress'}}">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? 'å·²å®Œæˆ' : item.canComplete ? 'é¢†å–' : 'æœªå®Œæˆ'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å‘¨ä»»åŠ¡ -->
    <view class="task-section" wx:if="{{weeklyTasks.length > 0}}">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">ğŸ“† å‘¨ä»»åŠ¡</text>
          <text class="title-desc">æŒ‘æˆ˜æ›´é«˜ç›®æ ‡</text>
        </view>
        <view class="title-right">
          <text class="refresh-time">æ¯å‘¨ä¸€åˆ·æ–°</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item weekly" 
              wx:for="{{weeklyTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? 'å·²å®Œæˆ' : item.canComplete ? 'é¢†å–' : Math.floor(item.progress / item.target * 100) + '%'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆå°±ä»»åŠ¡ -->
    <view class="task-section">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">ğŸ† æˆå°±ä»»åŠ¡</text>
          <text class="title-desc">é•¿æœŸç›®æ ‡ï¼Œä¸°åšå¥–åŠ±</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item achievement {{item.difficulty}}" 
              wx:for="{{achievementTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
            <view class="difficulty-badge {{item.difficulty}}">
              {{item.difficulty === 'easy' ? 'ç®€å•' : item.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾'}}
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? 'å·²å®Œæˆ' : item.canComplete ? 'é¢†å–' : Math.floor(item.progress / item.target * 100) + '%'}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†è®°å½• -->
  <view class="tab-content" wx:if="{{activeTab === 'records'}}">
    <!-- ç­›é€‰å™¨ -->
    <view class="record-filters">
      <view class="filter-tabs">
        <view class="filter-tab {{recordType === 'all' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="all">
          <text class="filter-icon">ğŸ“‹</text>
          <text class="filter-text">å…¨éƒ¨</text>
        </view>
        <view class="filter-tab {{recordType === 'earn' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="earn">
          <text class="filter-icon">ğŸ“ˆ</text>
          <text class="filter-text">è·å¾—</text>
        </view>
        <view class="filter-tab {{recordType === 'spend' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="spend">
          <text class="filter-icon">ğŸ“‰</text>
          <text class="filter-text">æ¶ˆè´¹</text>
        </view>
      </view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="record-list">
      <view class="record-item" 
            wx:for="{{filteredRecords}}" 
            wx:key="id">
        <view class="record-icon {{item.type}}">
          <text class="icon-text">{{item.icon}}</text>
        </view>
        <view class="record-info">
          <view class="record-title">{{item.title}}</view>
          <view class="record-desc">{{item.description}}</view>
          <view class="record-time">{{item.createTime}}</view>
        </view>
        <view class="record-points">
          <text class="points-change {{item.type === 'earn' ? 'earn' : 'spend'}}">
            {{item.type === 'earn' ? '+' : '-'}}{{item.points}}
          </text>
          <text class="points-unit">ç§¯åˆ†</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
      <view class="empty-icon">ğŸ“Š</view>
      <view class="empty-text">æš‚æ— è®°å½•</view>
      <view class="empty-desc">å®Œæˆä»»åŠ¡æˆ–å…‘æ¢å•†å“åä¼šæ˜¾ç¤ºè®°å½•</view>
    </view>
  </view>

  <!-- æ’è¡Œæ¦œ -->
  <view class="tab-content" wx:if="{{activeTab === 'ranking'}}">
    <!-- æˆ‘çš„æ’å -->
    <view class="my-ranking" wx:if="{{myRanking}}">
      <view class="ranking-title">æˆ‘çš„æ’å</view>
      <view class="ranking-item my-rank">
        <view class="rank-number">{{myRanking.rank}}</view>
        <view class="user-avatar">
          <image src="{{myRanking.avatar}}" mode="aspectFill" />
        </view>
        <view class="user-info">
          <view class="user-name">{{myRanking.name}}</view>
          <view class="user-level">{{myRanking.levelName}} Lv.{{myRanking.level}}</view>
        </view>
        <view class="user-points">
          <text class="points-number">{{myRanking.points}}</text>
          <text class="points-unit">ç§¯åˆ†</text>
          <view class="weekly-increase">
            <text class="increase-text">å‘¨å¢é•¿ +{{myRanking.weeklyIncrease}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
    <view class="ranking-list">
      <view class="ranking-title">ç§¯åˆ†æ’è¡Œæ¦œ</view>
      <view class="ranking-item" 
            wx:for="{{rankingList}}" 
            wx:key="id"
            class="{{item.isMe ? 'is-me' : ''}}">
        <view class="rank-number {{item.rank <= 3 ? 'top-three' : ''}}" 
              data-rank="{{item.rank}}">
          <text wx:if="{{item.rank === 1}}">ğŸ¥‡</text>
          <text wx:elif="{{item.rank === 2}}">ğŸ¥ˆ</text>
          <text wx:elif="{{item.rank === 3}}">ğŸ¥‰</text>
          <text wx:else>{{item.rank}}</text>
        </view>
        <view class="user-avatar">
          <image src="{{item.avatar}}" mode="aspectFill" />
          <view class="level-badge">{{item.level}}</view>
        </view>
        <view class="user-info">
          <view class="user-name">{{item.name}}</view>
          <view class="user-level">{{item.levelName}}</view>
        </view>
        <view class="user-points">
          <text class="points-number">{{item.points}}</text>
          <text class="points-unit">ç§¯åˆ†</text>
          <view class="weekly-increase" wx:if="{{item.weeklyIncrease > 0}}">
            <text class="increase-text">+{{item.weeklyIncrease}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && rankingList.length === 0}}">
      <view class="empty-icon">ğŸ†</view>
      <view class="empty-text">æš‚æ— æ’è¡Œæ•°æ®</view>
      <view class="empty-desc">åŠªåŠ›å­¦ä¹ ï¼Œäº‰å–ä¸Šæ¦œå§ï¼</view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- Toastæç¤º -->
<view class="toast-container" wx:if="{{showToast}}">
  <view class="toast-message">{{toastMessage}}</view>
</view>

<!-- å•†å“è¯¦æƒ…å¼¹çª— -->
<view class="popup-overlay" wx:if="{{showGoodsDetail}}" bindtap="closeGoodsDetail">
  <view class="goods-detail-popup" catch:tap="true">
    <view class="popup-header">
      <view class="popup-title">å•†å“è¯¦æƒ…</view>
      <view class="popup-close" bindtap="closeGoodsDetail">Ã—</view>
    </view>
    <view class="popup-content" wx:if="{{selectedGoods}}">
      <view class="detail-image">
        <image src="{{selectedGoods.image}}" mode="aspectFill" />
        <view class="image-badges">
          <view class="badge hot" wx:if="{{selectedGoods.isHot}}">ğŸ”¥ çƒ­é—¨</view>
          <view class="badge new" wx:if="{{selectedGoods.isNew}}">âœ¨ æ–°å“</view>
          <view class="badge discount" wx:if="{{selectedGoods.discount > 0}}">{{selectedGoods.discount}}% OFF</view>
        </view>
      </view>
      <view class="detail-info">
        <view class="detail-name">{{selectedGoods.name}}</view>
        <view class="detail-desc">{{selectedGoods.description}}</view>
        <view class="detail-meta">
          <view class="meta-item">
            <text class="meta-label">åº“å­˜ï¼š</text>
            <text class="meta-value">{{selectedGoods.stock}}ä»¶</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">å·²å…‘æ¢ï¼š</text>
            <text class="meta-value">{{selectedGoods.sales}}ä»¶</text>
          </view>
        </view>
        <view class="detail-price">
          <text class="price-number">{{selectedGoods.points}}</text>
          <text class="price-unit">ç§¯åˆ†</text>
          <text class="original-price" wx:if="{{selectedGoods.originalPoints > selectedGoods.points}}">åŸä»· {{selectedGoods.originalPoints}} ç§¯åˆ†</text>
        </view>
      </view>
      <view class="detail-actions">
        <button 
          class="exchange-button {{selectedGoods.stock === 0 || userPoints.current < selectedGoods.points ? 'disabled' : ''}}"
          disabled="{{selectedGoods.stock === 0 || userPoints.current < selectedGoods.points}}"
          bindtap="confirmExchange"
        >
          {{selectedGoods.stock === 0 ? 'å·²å”®ç½„' : userPoints.current < selectedGoods.points ? 'ç§¯åˆ†ä¸è¶³' : 'ç¡®è®¤å…‘æ¢'}}
        </button>
      </view>
    </view>
  </view>
</view>

<!-- å‡çº§å¼¹çª— -->
<view class="popup-overlay" wx:if="{{showLevelUpModal}}" bindtap="closeLevelUpModal">
  <view class="level-up-popup" catch:tap="true">
    <view class="level-up-content">
      <view class="level-up-icon">ğŸ‰</view>
      <view class="level-up-title">æ­å–œå‡çº§ï¼</view>
      <view class="level-progress">
        <view class="old-level">
          <text class="level-name">{{levelUpInfo.oldLevelName}}</text>
          <text class="level-number">Lv.{{levelUpInfo.oldLevel}}</text>
        </view>
        <view class="level-arrow">â†’</view>
        <view class="new-level">
          <text class="level-name">{{levelUpInfo.newLevelName}}</text>
          <text class="level-number">Lv.{{levelUpInfo.newLevel}}</text>
        </view>
      </view>
      <view class="level-rewards">
        <view class="rewards-title">å‡çº§å¥–åŠ±</view>
        <view class="rewards-list">
          <view class="reward-item" wx:for="{{levelUpInfo.rewards}}" wx:key="*this">
            <text class="reward-text">{{item}}</text>
          </view>
        </view>
      </view>
      <button class="level-up-btn" bindtap="closeLevelUpModal">å¤ªæ£’äº†ï¼</button>
    </view>
  </view>
</view>