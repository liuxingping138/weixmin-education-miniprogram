<!--pages/class/class.wxml-->
<view class="class-container">
  <!-- é¡¶éƒ¨ç­çº§ä¿¡æ¯ -->
  <view class="class-header">
    <view class="class-info">
      <view class="class-name">{{classInfo.name}}</view>
      <view class="class-desc">{{classInfo.description}}</view>
      <view class="class-meta">
        <text class="meta-item">{{classInfo.teacherName}}</text>
        <text class="meta-separator">Â·</text>
        <text class="meta-item">{{classInfo.semester}}</text>
      </view>
      <view class="class-stats">
        <view class="stat-item">
          <text class="stat-number">{{classInfo.studentCount}}</text>
          <text class="stat-label">å­¦ç”Ÿ</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{classInfo.avgScore}}</text>
          <text class="stat-label">å¹³å‡åˆ†</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{classInfo.completionRate}}%</text>
          <text class="stat-label">å®Œæˆç‡</text>
        </view>
      </view>
    </view>
    <view class="class-avatar">
      <t-avatar size="large" image="{{classInfo.avatar}}" />
    </view>
  </view>

  <!-- åŠŸèƒ½å¯¼èˆª -->
  <view class="function-nav">
    <view class="nav-item {{activeTab === 'students' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="students">
      <text>å­¦ç”Ÿæ¡£æ¡ˆ</text>
    </view>
    <view class="nav-item {{activeTab === 'ranking' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="ranking">
      <text>æ’è¡Œæ¦œ</text>
    </view>
    <view class="nav-item {{activeTab === 'groups' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="groups">
      <text>å°ç»„å¯¹æŠ—</text>
    </view>
    <view class="nav-item {{activeTab === 'activities' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="activities">
      <text>ç­çº§åŠ¨æ€</text>
    </view>
  </view>

  <!-- å­¦ç”Ÿæ¡£æ¡ˆ -->
  <view class="tab-content" wx:if="{{activeTab === 'students'}}">
    <view class="search-bar">
      <t-input 
        placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·"
        value="{{searchKeyword}}"
        bind:change="onSearchInput"
        prefix-icon="search"
        clearable
      />
    </view>
    
    <view class="student-list">
      <view class="student-item" 
            wx:for="{{filteredStudents}}" 
            wx:key="id"
            bindtap="viewStudentDetail"
            data-student="{{item}}">
        <view class="student-avatar">
          <t-avatar image="{{item.avatar}}" />
          <view class="online-status {{item.isOnline ? 'online' : 'offline'}}"></view>
        </view>
        <view class="student-info">
          <view class="student-name">{{item.name}}</view>
          <view class="student-number">å­¦å·ï¼š{{item.studentNumber}}</view>
          <view class="student-stats">
            <text class="stat">ç§¯åˆ†ï¼š{{item.points}}</text>
            <text class="stat">æ’åï¼š{{item.rank}}</text>
            <text class="stat">ç­‰çº§ï¼šLv.{{item.level}}</text>
          </view>
          <view class="student-badges" wx:if="{{item.badges.length > 0}}">
            <text class="badge" wx:for="{{item.badges}}" wx:key="*this" wx:for-item="badge">{{badge}}</text>
          </view>
        </view>
        <view class="student-actions">
          <t-button size="small" variant="outline" 
                    bindtap="sendMessage" 
                    data-student="{{item}}"
                    catch:tap="true">
            æ¶ˆæ¯
          </t-button>
          <t-button size="small" theme="primary" 
                    bindtap="rewardStudent" 
                    data-student="{{item}}"
                    catch:tap="true">
            å¥–åŠ±
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ’è¡Œæ¦œ -->
  <view class="tab-content" wx:if="{{activeTab === 'ranking'}}">
    <view class="ranking-filters">
      <view class="filter-tabs">
        <view class="filter-tab {{rankingType === 'points' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="points">
          ç§¯åˆ†æ¦œ
        </view>
        <view class="filter-tab {{rankingType === 'homework' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="homework">
          ä½œä¸šæ¦œ
        </view>
        <view class="filter-tab {{rankingType === 'attendance' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="attendance">
          å‡ºå‹¤æ¦œ
        </view>
      </view>
    </view>

    <view class="ranking-list">
      <view class="ranking-item" 
            wx:for="{{rankingList}}" 
            wx:key="id"
            class="{{index < 3 ? 'top-three' : ''}}">
        <view class="rank-number">
          <view wx:if="{{index === 0}}" class="rank-medal gold">ğŸ¥‡</view>
          <view wx:elif="{{index === 1}}" class="rank-medal silver">ğŸ¥ˆ</view>
          <view wx:elif="{{index === 2}}" class="rank-medal bronze">ğŸ¥‰</view>
          <text wx:else class="rank-text">{{index + 1}}</text>
        </view>
        <view class="student-avatar">
          <t-avatar image="{{item.avatar}}" />
        </view>
        <view class="student-info">
          <view class="student-name">{{item.name}}</view>
          <view class="student-class">{{item.className}}</view>
        </view>
        <view class="rank-score">
          <text class="score-number">{{item.score}}</text>
          <text class="score-unit">{{item.unit}}</text>
          <view class="score-trend {{item.trend}}">
            <text class="trend-icon">{{item.trend === 'up' ? 'â†—' : 'â†˜'}}</text>
            <text class="trend-value">{{item.trendValue}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å°ç»„å¯¹æŠ— -->
  <view class="tab-content" wx:if="{{activeTab === 'groups'}}">
    <view class="group-battle-header">
      <view class="battle-info">
        <view class="battle-title">æœ¬å‘¨å°ç»„å¯¹æŠ—</view>
        <view class="battle-subtitle">å›¢ç»“åä½œï¼Œå…±åŒè¿›æ­¥</view>
      </view>
      <view class="battle-time">
        <text class="time-label">å‰©ä½™æ—¶é—´</text>
        <text class="time-value">{{battleTimeLeft}}</text>
      </view>
    </view>

    <view class="group-list">
      <view class="group-item" 
            wx:for="{{groupList}}" 
            wx:key="id"
            class="{{item.rank === 1 ? 'leading' : ''}}"
            bindtap="viewGroupDetail"
            data-group="{{item}}">
        <view class="group-rank">
          <text class="rank-number">{{item.rank}}</text>
          <text wx:if="{{item.rank === 1}}" class="rank-crown">ğŸ‘‘</text>
        </view>
        <view class="group-info">
          <view class="group-name">{{item.name}}</view>
          <view class="group-members">
            <t-avatar 
              wx:for="{{item.members}}" 
              wx:for-item="member"
              wx:key="id"
              size="small" 
              image="{{member.avatar}}"
              class="member-avatar"
            />
            <text class="member-count">+{{item.members.length}}</text>
          </view>
          <view class="group-achievements" wx:if="{{item.achievements.length > 0}}">
            <text class="achievement" wx:for="{{item.achievements}}" wx:key="*this" wx:for-item="achievement">{{achievement}}</text>
          </view>
        </view>
        <view class="group-score">
          <text class="score">{{item.totalScore}}</text>
          <text class="unit">åˆ†</text>
          <view class="score-growth {{item.weeklyGrowth >= 0 ? 'positive' : 'negative'}}">
            <text class="growth-icon">{{item.weeklyGrowth >= 0 ? '+' : ''}}</text>
            <text class="growth-value">{{item.weeklyGrowth}}</text>
          </view>
        </view>
        <view class="group-progress">
          <view class="progress-bar">
            <view class="progress-fill" 
                  style="width: {{item.progress}}%"></view>
          </view>
          <text class="progress-text">{{item.progress}}%</text>
        </view>
      </view>
    </view>

    <view class="battle-rules" bindtap="showBattleRules">
      <text class="rules-text">ğŸ“‹ æŸ¥çœ‹å¯¹æŠ—è§„åˆ™</text>
    </view>
  </view>

  <!-- ç­çº§åŠ¨æ€ -->
  <view class="tab-content" wx:if="{{activeTab === 'activities'}}">
    <view class="activity-list">
      <view class="activity-item" 
            wx:for="{{classActivities}}" 
            wx:key="id">
        <view class="activity-icon">{{item.icon}}</view>
        <view class="activity-content">
          <view class="activity-title">{{item.title}}</view>
          <view class="activity-description">{{item.description}}</view>
          <view class="activity-time">{{item.time}}</view>
        </view>
        <view class="activity-type">
          <text class="type-tag {{item.type}}">{{item.type}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="large" text="åŠ è½½ä¸­..." />
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && isEmpty}}">
    <view class="empty-icon">ğŸ“š</view>
    <view class="empty-text">æš‚æ— æ•°æ®</view>
  </view>
</view>

<!-- Toastæç¤º -->
<t-toast 
  visible="{{showToast}}"
  message="{{toastMessage}}"
  duration="{{2000}}"
  bind:close="onToastClose"
/>

<!-- å­¦ç”Ÿè¯¦æƒ…å¼¹çª— -->
<t-popup 
  visible="{{showStudentDetail}}"
  placement="bottom"
  bind:visible-change="onStudentDetailClose"
>
  <view class="student-detail-popup">
    <view class="popup-header">
      <view class="popup-title">å­¦ç”Ÿè¯¦æƒ…</view>
      <view class="popup-close" bindtap="closeStudentDetail">Ã—</view>
    </view>
    <view class="popup-content" wx:if="{{selectedStudent}}">
      <view class="detail-avatar">
        <t-avatar size="large" image="{{selectedStudent.avatar}}" />
        <view class="detail-badges" wx:if="{{selectedStudent.badges.length > 0}}">
          <text class="badge" wx:for="{{selectedStudent.badges}}" wx:key="*this" wx:for-item="badge">{{badge}}</text>
        </view>
      </view>
      <view class="detail-info">
        <view class="detail-item">
          <text class="label">å§“åï¼š</text>
          <text class="value">{{selectedStudent.name}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å­¦å·ï¼š</text>
          <text class="value">{{selectedStudent.studentNumber}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ç§¯åˆ†ï¼š</text>
          <text class="value">{{selectedStudent.points}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ’åï¼š</text>
          <text class="value">ç¬¬{{selectedStudent.rank}}å</text>
        </view>
        <view class="detail-item">
          <text class="label">ç­‰çº§ï¼š</text>
          <text class="value">Lv.{{selectedStudent.level}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å‡ºå‹¤ç‡ï¼š</text>
          <text class="value">{{selectedStudent.attendanceRate}}%</text>
        </view>
        <view class="detail-item">
          <text class="label">ä½œä¸šå®Œæˆç‡ï¼š</text>
          <text class="value">{{selectedStudent.homeworkRate}}%</text>
        </view>
        <view class="detail-item">
          <text class="label">å¹³å‡åˆ†ï¼š</text>
          <text class="value">{{selectedStudent.avgScore}}åˆ†</text>
        </view>
        <view class="detail-item">
          <text class="label">å®¶é•¿è”ç³»ï¼š</text>
          <text class="value">{{selectedStudent.parentContact}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æœ€åæ´»è·ƒï¼š</text>
          <text class="value">{{selectedStudent.lastActiveTime}}</text>
        </view>
      </view>
      <view class="detail-actions">
        <t-button 
          theme="primary" 
          bindtap="viewStudentReport"
          data-student="{{selectedStudent}}"
        >
          æŸ¥çœ‹å­¦ä¹ æŠ¥å‘Š
        </t-button>
        <t-button 
          variant="outline" 
          bindtap="contactParent"
          data-student="{{selectedStudent}}"
        >
          è”ç³»å®¶é•¿
        </t-button>
      </view>
    </view>
  </view>
</t-popup>