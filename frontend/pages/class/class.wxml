<!--pages/class/class.wxml-->
<view class="class-container">
  <!-- 顶部班级信息 -->
  <view class="class-header">
    <view class="class-info">
      <view class="class-name">{{classInfo.name}}</view>
      <view class="class-desc">{{classInfo.description}}</view>
      <view class="class-meta">
        <text class="meta-item">{{classInfo.teacherName}}</text>
        <text class="meta-separator">·</text>
        <text class="meta-item">{{classInfo.semester}}</text>
      </view>
      <view class="class-stats">
        <view class="stat-item">
          <text class="stat-number">{{classInfo.studentCount}}</text>
          <text class="stat-label">学生</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{classInfo.avgScore}}</text>
          <text class="stat-label">平均分</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{classInfo.completionRate}}%</text>
          <text class="stat-label">完成率</text>
        </view>
      </view>
    </view>
    <view class="class-avatar">
      <t-avatar size="large" image="{{classInfo.avatar}}" />
    </view>
  </view>

  <!-- 功能导航 -->
  <view class="function-nav">
    <view class="nav-item {{activeTab === 'students' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="students">
      <text>学生档案</text>
    </view>
    <view class="nav-item {{activeTab === 'ranking' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="ranking">
      <text>排行榜</text>
    </view>
    <view class="nav-item {{activeTab === 'groups' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="groups">
      <text>小组对抗</text>
    </view>
    <view class="nav-item {{activeTab === 'activities' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="activities">
      <text>班级动态</text>
    </view>
  </view>

  <!-- 学生档案 -->
  <view class="tab-content" wx:if="{{activeTab === 'students'}}">
    <view class="search-bar">
      <t-input 
        placeholder="搜索学生姓名或学号"
        value="{{searchKeyword}}"
        bind:change="onSearchInput"
        prefix-icon="search"
        clearable
      />
    </view>
    
    <view class="student-list">
      <view class="student-item" 
            wx:for="{{filteredStudents}}" 
            wx:key="id"
            bindtap="viewStudentDetail"
            data-student="{{item}}">
        <view class="student-avatar">
          <t-avatar image="{{item.avatar}}" />
          <view class="online-status {{item.isOnline ? 'online' : 'offline'}}"></view>
        </view>
        <view class="student-info">
          <view class="student-name">{{item.name}}</view>
          <view class="student-number">学号：{{item.studentNumber}}</view>
          <view class="student-stats">
            <text class="stat">积分：{{item.points}}</text>
            <text class="stat">排名：{{item.rank}}</text>
            <text class="stat">等级：Lv.{{item.level}}</text>
          </view>
          <view class="student-badges" wx:if="{{item.badges.length > 0}}">
            <text class="badge" wx:for="{{item.badges}}" wx:key="*this" wx:for-item="badge">{{badge}}</text>
          </view>
        </view>
        <view class="student-actions">
          <t-button size="small" variant="outline" 
                    bindtap="sendMessage" 
                    data-student="{{item}}"
                    catch:tap="true">
            消息
          </t-button>
          <t-button size="small" theme="primary" 
                    bindtap="rewardStudent" 
                    data-student="{{item}}"
                    catch:tap="true">
            奖励
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- 排行榜 -->
  <view class="tab-content" wx:if="{{activeTab === 'ranking'}}">
    <view class="ranking-filters">
      <view class="filter-tabs">
        <view class="filter-tab {{rankingType === 'points' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="points">
          积分榜
        </view>
        <view class="filter-tab {{rankingType === 'homework' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="homework">
          作业榜
        </view>
        <view class="filter-tab {{rankingType === 'attendance' ? 'active' : ''}}" 
              bindtap="switchRankingType" data-type="attendance">
          出勤榜
        </view>
      </view>
    </view>

    <view class="ranking-list">
      <view class="ranking-item" 
            wx:for="{{rankingList}}" 
            wx:key="id"
            class="{{index < 3 ? 'top-three' : ''}}">
        <view class="rank-number">
          <view wx:if="{{index === 0}}" class="rank-medal gold">🥇</view>
          <view wx:elif="{{index === 1}}" class="rank-medal silver">🥈</view>
          <view wx:elif="{{index === 2}}" class="rank-medal bronze">🥉</view>
          <text wx:else class="rank-text">{{index + 1}}</text>
        </view>
        <view class="student-avatar">
          <t-avatar image="{{item.avatar}}" />
        </view>
        <view class="student-info">
          <view class="student-name">{{item.name}}</view>
          <view class="student-class">{{item.className}}</view>
        </view>
        <view class="rank-score">
          <text class="score-number">{{item.score}}</text>
          <text class="score-unit">{{item.unit}}</text>
          <view class="score-trend {{item.trend}}">
            <text class="trend-icon">{{item.trend === 'up' ? '↗' : '↘'}}</text>
            <text class="trend-value">{{item.trendValue}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 小组对抗 -->
  <view class="tab-content" wx:if="{{activeTab === 'groups'}}">
    <view class="group-battle-header">
      <view class="battle-info">
        <view class="battle-title">本周小组对抗</view>
        <view class="battle-subtitle">团结协作，共同进步</view>
      </view>
      <view class="battle-time">
        <text class="time-label">剩余时间</text>
        <text class="time-value">{{battleTimeLeft}}</text>
      </view>
    </view>

    <view class="group-list">
      <view class="group-item" 
            wx:for="{{groupList}}" 
            wx:key="id"
            class="{{item.rank === 1 ? 'leading' : ''}}"
            bindtap="viewGroupDetail"
            data-group="{{item}}">
        <view class="group-rank">
          <text class="rank-number">{{item.rank}}</text>
          <text wx:if="{{item.rank === 1}}" class="rank-crown">👑</text>
        </view>
        <view class="group-info">
          <view class="group-name">{{item.name}}</view>
          <view class="group-members">
            <t-avatar 
              wx:for="{{item.members}}" 
              wx:for-item="member"
              wx:key="id"
              size="small" 
              image="{{member.avatar}}"
              class="member-avatar"
            />
            <text class="member-count">+{{item.members.length}}</text>
          </view>
          <view class="group-achievements" wx:if="{{item.achievements.length > 0}}">
            <text class="achievement" wx:for="{{item.achievements}}" wx:key="*this" wx:for-item="achievement">{{achievement}}</text>
          </view>
        </view>
        <view class="group-score">
          <text class="score">{{item.totalScore}}</text>
          <text class="unit">分</text>
          <view class="score-growth {{item.weeklyGrowth >= 0 ? 'positive' : 'negative'}}">
            <text class="growth-icon">{{item.weeklyGrowth >= 0 ? '+' : ''}}</text>
            <text class="growth-value">{{item.weeklyGrowth}}</text>
          </view>
        </view>
        <view class="group-progress">
          <view class="progress-bar">
            <view class="progress-fill" 
                  style="width: {{item.progress}}%"></view>
          </view>
          <text class="progress-text">{{item.progress}}%</text>
        </view>
      </view>
    </view>

    <view class="battle-rules" bindtap="showBattleRules">
      <text class="rules-text">📋 查看对抗规则</text>
    </view>
  </view>

  <!-- 班级动态 -->
  <view class="tab-content" wx:if="{{activeTab === 'activities'}}">
    <view class="activity-list">
      <view class="activity-item" 
            wx:for="{{classActivities}}" 
            wx:key="id">
        <view class="activity-icon">{{item.icon}}</view>
        <view class="activity-content">
          <view class="activity-title">{{item.title}}</view>
          <view class="activity-description">{{item.description}}</view>
          <view class="activity-time">{{item.time}}</view>
        </view>
        <view class="activity-type">
          <text class="type-tag {{item.type}}">{{item.type}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="large" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{!loading && isEmpty}}">
    <view class="empty-icon">📚</view>
    <view class="empty-text">暂无数据</view>
  </view>
</view>

<!-- Toast提示 -->
<t-toast 
  visible="{{showToast}}"
  message="{{toastMessage}}"
  duration="{{2000}}"
  bind:close="onToastClose"
/>

<!-- 学生详情弹窗 -->
<t-popup 
  visible="{{showStudentDetail}}"
  placement="bottom"
  bind:visible-change="onStudentDetailClose"
>
  <view class="student-detail-popup">
    <view class="popup-header">
      <view class="popup-title">学生详情</view>
      <view class="popup-close" bindtap="closeStudentDetail">×</view>
    </view>
    <view class="popup-content" wx:if="{{selectedStudent}}">
      <view class="detail-avatar">
        <t-avatar size="large" image="{{selectedStudent.avatar}}" />
        <view class="detail-badges" wx:if="{{selectedStudent.badges.length > 0}}">
          <text class="badge" wx:for="{{selectedStudent.badges}}" wx:key="*this" wx:for-item="badge">{{badge}}</text>
        </view>
      </view>
      <view class="detail-info">
        <view class="detail-item">
          <text class="label">姓名：</text>
          <text class="value">{{selectedStudent.name}}</text>
        </view>
        <view class="detail-item">
          <text class="label">学号：</text>
          <text class="value">{{selectedStudent.studentNumber}}</text>
        </view>
        <view class="detail-item">
          <text class="label">积分：</text>
          <text class="value">{{selectedStudent.points}}</text>
        </view>
        <view class="detail-item">
          <text class="label">排名：</text>
          <text class="value">第{{selectedStudent.rank}}名</text>
        </view>
        <view class="detail-item">
          <text class="label">等级：</text>
          <text class="value">Lv.{{selectedStudent.level}}</text>
        </view>
        <view class="detail-item">
          <text class="label">出勤率：</text>
          <text class="value">{{selectedStudent.attendanceRate}}%</text>
        </view>
        <view class="detail-item">
          <text class="label">作业完成率：</text>
          <text class="value">{{selectedStudent.homeworkRate}}%</text>
        </view>
        <view class="detail-item">
          <text class="label">平均分：</text>
          <text class="value">{{selectedStudent.avgScore}}分</text>
        </view>
        <view class="detail-item">
          <text class="label">家长联系：</text>
          <text class="value">{{selectedStudent.parentContact}}</text>
        </view>
        <view class="detail-item">
          <text class="label">最后活跃：</text>
          <text class="value">{{selectedStudent.lastActiveTime}}</text>
        </view>
      </view>
      <view class="detail-actions">
        <t-button 
          theme="primary" 
          bindtap="viewStudentReport"
          data-student="{{selectedStudent}}"
        >
          查看学习报告
        </t-button>
        <t-button 
          variant="outline" 
          bindtap="contactParent"
          data-student="{{selectedStudent}}"
        >
          联系家长
        </t-button>
      </view>
    </view>
  </view>
</t-popup>