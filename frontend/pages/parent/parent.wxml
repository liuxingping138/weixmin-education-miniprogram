<!--pages/parent/parent.wxml-->
<view class="parent-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="åŠ è½½ä¸­..." />
  
  <!-- é¡¶éƒ¨åŠŸèƒ½ä»‹ç» -->
  <view class="header-section">
    <view class="feature-intro">
      <view class="intro-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</view>
      <view class="intro-content">
        <view class="intro-title">å®¶æ ¡äº’åŠ¨å¹³å°</view>
        <view class="intro-desc">è¿æ¥å®¶åº­ä¸å­¦æ ¡ï¼Œå…±åŒå…³æ³¨å­©å­æˆé•¿</view>
      </view>
    </view>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{parentStats.reports}}</view>
        <view class="stat-label">å­¦ä¹ æŠ¥å‘Š</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{parentStats.messages}}</view>
        <view class="stat-label">äº’åŠ¨æ¶ˆæ¯</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{parentStats.activities}}</view>
        <view class="stat-label">å‚ä¸æ´»åŠ¨</view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½å¯¼èˆª -->
  <view class="nav-tabs">
    <view 
      class="nav-tab {{activeTab === 'report' ? 'active' : ''}}"
      data-tab="report"
      bindtap="switchTab"
    >
      <view class="tab-icon">ğŸ“Š</view>
      <view class="tab-text">å­¦ä¹ æŠ¥å‘Š</view>
    </view>
    <view 
      class="nav-tab {{activeTab === 'archive' ? 'active' : ''}}"
      data-tab="archive"
      bindtap="switchTab"
    >
      <view class="tab-icon">ğŸ“</view>
      <view class="tab-text">æˆé•¿æ¡£æ¡ˆ</view>
    </view>
    <view 
      class="nav-tab {{activeTab === 'communication' ? 'active' : ''}}"
      data-tab="communication"
      bindtap="switchTab"
    >
      <view class="tab-icon">ğŸ’¬</view>
      <view class="tab-text">å®¶æ ¡æ²Ÿé€š</view>
    </view>
  </view>

  <!-- å­¦ä¹ æŠ¥å‘Šé¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'report'}}">
    <!-- æŠ¥å‘Šç”Ÿæˆ -->
    <view class="report-generator">
      <view class="generator-header">
        <view class="header-title">
          <view class="title-icon">ğŸ“‹</view>
          <text>ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š</text>
        </view>
      </view>
      
      <view class="generator-config">
        <!-- å­¦ç”Ÿé€‰æ‹© -->
        <view class="config-item">
          <view class="item-label">é€‰æ‹©å­¦ç”Ÿ</view>
          <view class="student-selector">
            <view 
              wx:for="{{students}}" 
              wx:key="id"
              class="student-option {{selectedStudent === item.id ? 'selected' : ''}}"
              data-student="{{item.id}}"
              bindtap="selectStudent"
            >
              <image src="{{item.avatar}}" class="student-avatar" />
              <view class="student-name">{{item.name}}</view>
            </view>
          </view>
        </view>
        
        <!-- æŠ¥å‘Šç±»å‹ -->
        <view class="config-item">
          <view class="item-label">æŠ¥å‘Šç±»å‹</view>
          <view class="report-types">
            <view 
              wx:for="{{reportTypes}}" 
              wx:key="id"
              class="type-option {{selectedReportType === item.id ? 'selected' : ''}}"
              data-type="{{item.id}}"
              bindtap="selectReportType"
            >
              <view class="type-icon">{{item.icon}}</view>
              <view class="type-name">{{item.name}}</view>
              <view class="type-desc">{{item.description}}</view>
            </view>
          </view>
        </view>
        
        <!-- æ—¶é—´èŒƒå›´ -->
        <view class="config-item">
          <view class="item-label">æ—¶é—´èŒƒå›´</view>
          <view class="time-range">
            <view 
              wx:for="{{timeRanges}}" 
              wx:key="id"
              class="range-option {{selectedTimeRange === item.id ? 'selected' : ''}}"
              data-range="{{item.id}}"
              bindtap="selectTimeRange"
            >
              {{item.name}}
            </view>
          </view>
        </view>
        
        <!-- ç”ŸæˆæŒ‰é’® -->
        <view class="generate-actions">
          <t-button 
            theme="primary" 
            size="large"
            loading="{{generatingReport}}"
            disabled="{{!canGenerateReport}}"
            bind:tap="generateReport"
          >
            {{generatingReport ? 'ç”Ÿæˆä¸­...' : 'ç”ŸæˆæŠ¥å‘Š'}}
          </t-button>
        </view>
      </view>
    </view>
    
    <!-- å†å²æŠ¥å‘Š -->
    <view class="report-history" wx:if="{{reportHistory.length > 0}}">
      <view class="history-header">
        <view class="history-title">
          <view class="title-icon">ğŸ“š</view>
          <text>å†å²æŠ¥å‘Š</text>
        </view>
      </view>
      
      <view class="report-list">
        <view 
          wx:for="{{reportHistory}}" 
          wx:key="id"
          class="report-item"
          data-report="{{item}}"
          bindtap="viewReport"
        >
          <view class="report-icon">
            <view class="icon-bg {{item.type}}">{{item.typeIcon}}</view>
          </view>
          <view class="report-info">
            <view class="report-title">{{item.title}}</view>
            <view class="report-meta">
              <view class="meta-item">
                <view class="meta-icon">ğŸ‘¤</view>
                <text>{{item.studentName}}</text>
              </view>
              <view class="meta-item">
                <view class="meta-icon">ğŸ“…</view>
                <text>{{item.createTime}}</text>
              </view>
              <view class="meta-item">
                <view class="meta-icon">ğŸ“„</view>
                <text>{{item.pages}}é¡µ</text>
              </view>
            </view>
          </view>
          <view class="report-actions">
            <t-button 
              size="small" 
              theme="light"
              data-report="{{item}}"
              bind:tap="downloadReport"
              catch:tap="true"
            >
              ä¸‹è½½
            </t-button>
            <t-button 
              size="small" 
              theme="primary"
              data-report="{{item}}"
              bind:tap="shareReport"
              catch:tap="true"
            >
              åˆ†äº«
            </t-button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆé•¿æ¡£æ¡ˆé¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'archive'}}">
    <!-- æ¡£æ¡ˆæ¦‚è§ˆ -->
    <view class="archive-overview">
      <view class="overview-header">
        <view class="header-title">
          <view class="title-icon">ğŸ“–</view>
          <text>æˆé•¿æ¡£æ¡ˆ</text>
        </view>
        <view class="header-actions">
          <t-button size="small" theme="primary" bind:tap="exportArchive">
            å¯¼å‡ºPDF
          </t-button>
        </view>
      </view>
      
      <!-- å­¦ç”Ÿæ¡£æ¡ˆå¡ç‰‡ -->
      <view class="student-cards">
        <view 
          wx:for="{{studentArchives}}" 
          wx:key="id"
          class="student-card"
          data-student="{{item}}"
          bindtap="viewStudentArchive"
        >
          <view class="card-header">
            <image src="{{item.avatar}}" class="student-photo" />
            <view class="student-info">
              <view class="student-name">{{item.name}}</view>
              <view class="student-class">{{item.className}}</view>
              <view class="student-id">å­¦å·ï¼š{{item.studentId}}</view>
            </view>
          </view>
          
          <view class="card-stats">
            <view class="stat-row">
              <view class="stat-item">
                <view class="stat-label">æ€»ç§¯åˆ†</view>
                <view class="stat-value">{{item.totalPoints}}</view>
              </view>
              <view class="stat-item">
                <view class="stat-label">å®Œæˆä½œä¸š</view>
                <view class="stat-value">{{item.completedHomework}}</view>
              </view>
            </view>
            <view class="stat-row">
              <view class="stat-item">
                <view class="stat-label">å¹³å‡åˆ†</view>
                <view class="stat-value">{{item.averageScore}}</view>
              </view>
              <view class="stat-item">
                <view class="stat-label">ç­çº§æ’å</view>
                <view class="stat-value">{{item.classRank}}</view>
              </view>
            </view>
          </view>
          
          <view class="card-progress">
            <view class="progress-item">
              <view class="progress-label">å­¦ä¹ è¿›åº¦</view>
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.learningProgress}}%"></view>
              </view>
              <view class="progress-text">{{item.learningProgress}}%</view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æˆé•¿è®°å½• -->
    <view class="growth-records">
      <view class="records-header">
        <view class="header-title">
          <view class="title-icon">ğŸŒ±</view>
          <text>æˆé•¿è®°å½•</text>
        </view>
        <view class="header-filter">
          <view 
            wx:for="{{recordTypes}}" 
            wx:key="id"
            class="filter-option {{selectedRecordType === item.id ? 'active' : ''}}"
            data-type="{{item.id}}"
            bindtap="selectRecordType"
          >
            {{item.name}}
          </view>
        </view>
      </view>
      
      <view class="record-timeline">
        <view 
          wx:for="{{filteredRecords}}" 
          wx:key="id"
          class="timeline-item"
        >
          <view class="timeline-dot {{item.type}}"></view>
          <view class="timeline-content">
            <view class="record-header">
              <view class="record-title">{{item.title}}</view>
              <view class="record-time">{{item.time}}</view>
            </view>
            <view class="record-desc">{{item.description}}</view>
            <view class="record-media" wx:if="{{item.images.length > 0}}">
              <image 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:key="*this"
                src="{{img}}"
                class="record-image"
                mode="aspectFill"
                data-images="{{item.images}}"
                data-current="{{index}}"
                bindtap="previewImages"
              />
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å®¶æ ¡æ²Ÿé€šé¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'communication'}}">
    <!-- æ²Ÿé€šæ–¹å¼ -->
    <view class="communication-methods">
      <view class="method-grid">
        <view class="method-item" bindtap="openTeacherChat">
          <view class="method-icon teacher">ğŸ‘©â€ğŸ«</view>
          <view class="method-name">è€å¸ˆç§èŠ</view>
          <view class="method-desc">ä¸ä»»è¯¾è€å¸ˆä¸€å¯¹ä¸€æ²Ÿé€š</view>
          <view class="method-badge" wx:if="{{unreadTeacherMessages > 0}}">{{unreadTeacherMessages}}</view>
        </view>
        
        <view class="method-item" bindtap="openClassGroup">
          <view class="method-icon group">ğŸ‘¥</view>
          <view class="method-name">ç­çº§ç¾¤èŠ</view>
          <view class="method-desc">å‚ä¸ç­çº§ç¾¤ç»„è®¨è®º</view>
          <view class="method-badge" wx:if="{{unreadGroupMessages > 0}}">{{unreadGroupMessages}}</view>
        </view>
        
        <view class="method-item" bindtap="openNotifications">
          <view class="method-icon notice">ğŸ“¢</view>
          <view class="method-name">é€šçŸ¥å…¬å‘Š</view>
          <view class="method-desc">æŸ¥çœ‹å­¦æ ¡é‡è¦é€šçŸ¥</view>
          <view class="method-badge" wx:if="{{unreadNotifications > 0}}">{{unreadNotifications}}</view>
        </view>
        
        <view class="method-item" bindtap="openFeedback">
          <view class="method-icon feedback">ğŸ’­</view>
          <view class="method-name">æ„è§åé¦ˆ</view>
          <view class="method-desc">å‘å­¦æ ¡æå‡ºå»ºè®®</view>
        </view>
      </view>
    </view>
    
    <!-- æœ€è¿‘æ¶ˆæ¯ -->
    <view class="recent-messages">
      <view class="messages-header">
        <view class="header-title">
          <view class="title-icon">ğŸ’¬</view>
          <text>æœ€è¿‘æ¶ˆæ¯</text>
        </view>
        <view class="header-action" bindtap="viewAllMessages">
          æŸ¥çœ‹å…¨éƒ¨
        </view>
      </view>
      
      <view class="message-list">
        <view 
          wx:for="{{recentMessages}}" 
          wx:key="id"
          class="message-item {{item.unread ? 'unread' : ''}}"
          data-message="{{item}}"
          bindtap="openMessage"
        >
          <view class="message-avatar">
            <image src="{{item.senderAvatar}}" class="sender-avatar" />
            <view class="message-type-badge {{item.type}}">{{item.typeIcon}}</view>
          </view>
          <view class="message-content">
            <view class="message-header">
              <view class="sender-name">{{item.senderName}}</view>
              <view class="message-time">{{item.time}}</view>
            </view>
            <view class="message-preview">{{item.preview}}</view>
            <view class="message-meta" wx:if="{{item.attachments > 0}}">
              <view class="meta-icon">ğŸ“</view>
              <text>{{item.attachments}}ä¸ªé™„ä»¶</text>
            </view>
          </view>
          <view class="message-status">
            <view class="unread-dot" wx:if="{{item.unread}}"></view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <view class="actions-header">
        <view class="header-title">
          <view class="title-icon">âš¡</view>
          <text>å¿«æ·æ“ä½œ</text>
        </view>
      </view>
      
      <view class="action-grid">
        <view class="action-item" bindtap="requestLeave">
          <view class="action-icon">ğŸ¥</view>
          <view class="action-name">è¯·å‡ç”³è¯·</view>
        </view>
        
        <view class="action-item" bindtap="scheduleParentMeeting">
          <view class="action-icon">ğŸ“…</view>
          <view class="action-name">é¢„çº¦å®¶é•¿ä¼š</view>
        </view>
        
        <view class="action-item" bindtap="reportIssue">
          <view class="action-icon">âš ï¸</view>
          <view class="action-name">é—®é¢˜åé¦ˆ</view>
        </view>
        
        <view class="action-item" bindtap="viewSchedule">
          <view class="action-icon">ğŸ“‹</view>
          <view class="action-name">è¯¾ç¨‹è¡¨</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <t-empty 
    wx:if="{{isEmpty && !loading}}"
    icon="data"
    description="æš‚æ— æ•°æ®"
  />

  <!-- Toastæç¤º -->
  <t-toast 
    visible="{{showToast}}"
    message="{{toastMessage}}"
    bind:close="onToastClose"
  />

  <!-- æŠ¥å‘Šè¯¦æƒ…å¼¹çª— -->
  <t-popup 
    visible="{{showReportDetail}}"
    placement="bottom"
    bind:visible-change="onReportDetailClose"
  >
    <view class="report-detail" wx:if="{{selectedReport}}">
      <view class="detail-header">
        <view class="detail-title">{{selectedReport.title}}</view>
        <view class="detail-close" bindtap="closeReportDetail">âœ•</view>
      </view>
      
      <view class="detail-preview">
        <image 
          src="{{selectedReport.preview}}"
          class="report-preview-image"
          mode="aspectFit"
        />
      </view>
      
      <view class="detail-info">
        <view class="info-row">
          <view class="info-label">å­¦ç”Ÿ</view>
          <view class="info-value">{{selectedReport.studentName}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">ç±»å‹</view>
          <view class="info-value">{{selectedReport.typeName}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">æ—¶é—´èŒƒå›´</view>
          <view class="info-value">{{selectedReport.timeRange}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">ç”Ÿæˆæ—¶é—´</view>
          <view class="info-value">{{selectedReport.createTime}}</view>
        </view>
        <view class="info-row">
          <view class="info-label">é¡µæ•°</view>
          <view class="info-value">{{selectedReport.pages}}é¡µ</view>
        </view>
      </view>
      
      <view class="detail-actions">
        <t-button 
          theme="light" 
          size="large"
          bind:tap="downloadSelectedReport"
        >
          ä¸‹è½½PDF
        </t-button>
        <t-button 
          theme="primary" 
          size="large"
          bind:tap="shareSelectedReport"
        >
          åˆ†äº«æŠ¥å‘Š
        </t-button>
      </view>
    </view>
  </t-popup>

  <!-- å­¦ç”Ÿæ¡£æ¡ˆè¯¦æƒ…å¼¹çª— -->
  <t-popup 
    visible="{{showArchiveDetail}}"
    placement="bottom"
    bind:visible-change="onArchiveDetailClose"
  >
    <view class="archive-detail" wx:if="{{selectedStudentArchive}}">
      <view class="detail-header">
        <view class="detail-title">{{selectedStudentArchive.name}}çš„æˆé•¿æ¡£æ¡ˆ</view>
        <view class="detail-close" bindtap="closeArchiveDetail">âœ•</view>
      </view>
      
      <view class="detail-content">
        <view class="archive-summary">
          <view class="summary-item">
            <view class="summary-label">åœ¨æ ¡å¤©æ•°</view>
            <view class="summary-value">{{selectedStudentArchive.schoolDays}}å¤©</view>
          </view>
          <view class="summary-item">
            <view class="summary-label">è·å¾—å¥–åŠ±</view>
            <view class="summary-value">{{selectedStudentArchive.rewards}}æ¬¡</view>
          </view>
          <view class="summary-item">
            <view class="summary-label">å‚ä¸æ´»åŠ¨</view>
            <view class="summary-value">{{selectedStudentArchive.activities}}æ¬¡</view>
          </view>
        </view>
        
        <view class="archive-highlights">
          <view class="highlights-title">æˆé•¿äº®ç‚¹</view>
          <view class="highlight-list">
            <view 
              wx:for="{{selectedStudentArchive.highlights}}" 
              wx:key="*this"
              class="highlight-item"
            >
              âœ¨ {{item}}
            </view>
          </view>
        </view>
      </view>
      
      <view class="detail-actions">
        <t-button 
          theme="light" 
          size="large"
          bind:tap="exportSelectedArchive"
        >
          å¯¼å‡ºæ¡£æ¡ˆ
        </t-button>
        <t-button 
          theme="primary" 
          size="large"
          bind:tap="shareSelectedArchive"
        >
          åˆ†äº«æ¡£æ¡ˆ
        </t-button>
      </view>
    </view>
  </t-popup>
</view>