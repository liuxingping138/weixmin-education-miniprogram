<!--pages/shop/shop.wxml-->
<view class="container">
  <!-- 顶部积分信息 -->
  <view class="points-header">
    <view class="points-info">
      <t-icon name="star" class="points-icon" />
      <view class="points-details">
        <text class="points-label">我的积分</text>
        <text class="points-value">{{userPoints}}</text>
      </view>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="getMorePoints">
        <t-icon name="add" class="action-icon" />
        <text class="action-text">赚积分</text>
      </view>
      <view class="action-btn" bindtap="showExchangeHistory">
        <t-icon name="time" class="action-icon" />
        <text class="action-text">兑换记录</text>
      </view>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-section">
    <view class="search-box" wx:if="{{showSearch}}">
      <input 
        class="search-input"
        placeholder="搜索商品"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="performSearch"
        focus="{{showSearch}}"
      />
      <view class="search-actions">
        <text class="search-btn" bindtap="performSearch">搜索</text>
        <text class="cancel-btn" bindtap="clearSearch">取消</text>
      </view>
    </view>
    <view class="search-trigger" wx:else bindtap="showSearchBox">
      <t-icon name="search" class="search-icon" />
      <text class="search-placeholder">搜索商品</text>
    </view>
  </view>

  <!-- 分类导航 -->
  <view class="category-nav">
    <scroll-view class="category-scroll" scroll-x="true">
      <view class="category-list">
        <view 
          class="category-item {{item.active ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:key="id"
          bindtap="switchCategory"
          data-id="{{item.id}}"
        >
          <text class="category-text">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 商品列表 -->
  <view class="shop-content">
    <view class="shop-grid" wx:if="{{shopItems.length > 0}}">
      <view 
        class="shop-item"
        wx:for="{{shopItems}}"
        wx:key="id"
        bindtap="viewItemDetail"
        data-id="{{item.id}}"
      >
        <view class="item-image-wrapper">
          <image class="item-image" src="{{item.image}}" mode="aspectFill" />
          <view class="item-badge" wx:if="{{item.isHot}}">热门</view>
          <view class="item-badge new" wx:if="{{item.isNew}}">新品</view>
        </view>
        
        <view class="item-info">
          <text class="item-name">{{item.name}}</text>
          <text class="item-desc">{{item.description}}</text>
          
          <view class="item-footer">
            <view class="item-points">
              <t-icon name="star" class="points-mini-icon" />
              <text class="points-text">{{item.points}}</text>
            </view>
            
            <view class="item-stock">
              <text class="stock-text">库存 {{item.stock}}</text>
            </view>
          </view>
          
          <button 
            class="exchange-btn {{userPoints < item.points ? 'disabled' : ''}} {{item.stock <= 0 ? 'sold-out' : ''}}"
            bindtap="exchangeItem"
            data-id="{{item.id}}"
            disabled="{{userPoints < item.points || item.stock <= 0}}"
            catchtap="exchangeItem"
          >
            {{item.stock <= 0 ? '已售罄' : (userPoints < item.points ? '积分不足' : '立即兑换')}}
          </button>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && shopItems.length === 0}}">
      <image class="empty-icon" src="/images/empty-shop.png" />
      <text class="empty-text">暂无商品</text>
      <text class="empty-tip">敬请期待更多精彩商品</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <image class="loading-icon" src="/images/loading.gif" />
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 兑换记录弹窗 -->
<view class="history-modal {{showHistory ? 'show' : ''}}" catchtouchmove="true">
  <view class="modal-mask" bindtap="hideExchangeHistory"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">兑换记录</text>
      <t-icon name="close" class="modal-close" bindtap="hideExchangeHistory" />
    </view>
    
    <scroll-view class="modal-body" scroll-y="true">
      <view class="history-list" wx:if="{{exchangeHistory.length > 0}}">
        <view 
          class="history-item"
          wx:for="{{exchangeHistory}}"
          wx:key="id"
          bindtap="viewExchangeDetail"
          data-id="{{item.id}}"
        >
          <image class="history-image" src="{{item.itemImage}}" mode="aspectFill" />
          <view class="history-info">
            <text class="history-name">{{item.itemName}}</text>
            <text class="history-time">{{item.exchangeTime}}</text>
            <text class="history-status status-{{item.status}}">{{item.statusText}}</text>
          </view>
          <view class="history-points">
            <text class="points-cost">-{{item.points}}</text>
          </view>
        </view>
      </view>
      
      <view class="empty-history" wx:else>
        <image class="empty-icon" src="/images/empty-history.png" />
        <text class="empty-text">暂无兑换记录</text>
      </view>
    </scroll-view>
  </view>
</view>