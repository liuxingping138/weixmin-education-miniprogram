<!--pages/index/index.wxml-->
<view class="container">
  <!-- 顶部用户信息 -->
  <view class="header-section">
    <view class="user-info">
      <image class="avatar" src="{{userInfo.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
      <view class="user-details">
        <text class="username">{{userInfo.name || '未登录'}}</text>
        <text class="user-type">{{userTypeText}}</text>
      </view>
    </view>
    
    <!-- 简化模式切换 -->
    <view class="mode-switch" bindtap="toggleSimpleMode">
      <t-icon name="{{simpleMode ? 'view-list' : 'apps'}}" size="40rpx" color="rgba(255,255,255,0.8)"></t-icon>
    </view>
    
    <!-- 学生积分显示 -->
    <view class="points-info" wx:if="{{userType === 'student'}}">
      <text class="points-label">积分</text>
      <text class="points-value">{{coreStats.points.total || 0}}</text>
    </view>
  </view>

  <!-- 快捷功能（优化版） -->
  <view class="quick-actions">
    <view class="section-header">
      <text class="section-title">快捷操作</text>
      <text class="section-subtitle">点击进入对应功能</text>
    </view>
    
    <view class="action-grid {{simpleMode ? 'simple-grid' : 'full-grid'}}">
      <view 
        class="action-item guide-target-{{item.id}}" 
        wx:for="{{quickActions}}" 
        wx:key="id"
        data-action="{{item}}"
        data-id="{{item.id}}"
        bindtap="onQuickActionTap"
      >
        <view class="action-icon-wrapper" style="background-color: {{item.color}}20;">
          <t-icon class="action-icon" name="{{item.icon}}" size="48rpx" color="{{item.color}}"></t-icon>
        </view>
        <view class="action-content">
          <text class="action-text">{{item.name}}</text>
          <text class="action-desc" wx:if="{{!simpleMode}}">{{item.description}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 核心数据统计（简化版） -->
  <view class="core-stats">
    <view class="section-header">
      <text class="section-title">数据概览</text>
      <text class="section-subtitle">核心数据一目了然</text>
    </view>
    
    <!-- 教师数据 -->
    <view class="stats-grid" wx:if="{{userType === 'teacher'}}">
      <view class="stat-item primary">
        <text class="stat-value">{{coreStats.students.total || 0}}</text>
        <text class="stat-label">学生总数</text>
        <text class="stat-sub" wx:if="{{coreStats.students.active}}">{{coreStats.students.active}}人在线</text>
      </view>
      <view class="stat-item success">
        <text class="stat-value">{{coreStats.homework.completed || 0}}</text>
        <text class="stat-label">已完成作业</text>
        <text class="stat-sub" wx:if="{{coreStats.homework.total}}">共{{coreStats.homework.total}}份</text>
      </view>
      <view class="stat-item warning">
        <text class="stat-value">{{coreStats.homework.pending || 0}}</text>
        <text class="stat-label">待完成作业</text>
      </view>
      <view class="stat-item info">
        <text class="stat-value">{{coreStats.classes.avgScore || 0}}</text>
        <text class="stat-label">班级均分</text>
      </view>
    </view>
    
    <!-- 学生数据 -->
    <view class="stats-grid" wx:if="{{userType === 'student'}}">
      <view class="stat-item primary">
        <text class="stat-value">{{coreStats.homework.completed || 0}}</text>
        <text class="stat-label">已完成作业</text>
      </view>
      <view class="stat-item warning">
        <text class="stat-value">{{coreStats.homework.pending || 0}}</text>
        <text class="stat-label">待完成作业</text>
      </view>
      <view class="stat-item success">
        <text class="stat-value">{{coreStats.points.todayEarned || 0}}</text>
        <text class="stat-label">今日获得积分</text>
      </view>
      <view class="stat-item info">
        <text class="stat-value">{{coreStats.performance.rank || '-'}}</text>
        <text class="stat-label">班级排名</text>
      </view>
    </view>
    
    <!-- 家长数据 -->
    <view class="stats-grid" wx:if="{{userType === 'parent'}}">
      <view class="stat-item primary">
        <text class="stat-value">{{coreStats.children.total || 0}}</text>
        <text class="stat-label">孩子数量</text>
      </view>
      <view class="stat-item success">
        <text class="stat-value">{{coreStats.performance.avgScore || 0}}</text>
        <text class="stat-label">平均成绩</text>
      </view>
      <view class="stat-item info">
        <text class="stat-value">{{coreStats.performance.completionRatePercent || 0}}%</text>
        <text class="stat-label">作业完成率</text>
      </view>
    </view>
  </view>

  <!-- 最近活动（简化版） -->
  <view class="recent-activities" wx:if="{{recentActivities.length > 0}}">
    <view class="section-header">
      <text class="section-title">最近活动</text>
      <text class="more-link" bindtap="onQuickActionTap" data-action="{{quickActions[1]}}">查看更多</text>
    </view>
    
    <view class="activity-list">
      <view class="activity-item" wx:for="{{recentActivities}}" wx:key="id">
        <view class="activity-indicator {{item.type}}"></view>
        <view class="activity-content">
          <text class="activity-text">{{item.content}}</text>
          <text class="activity-time">{{item.time}}</text>
        </view>
        <view class="activity-status" wx:if="{{item.status}}">
          <text class="status-badge status-{{item.status}}">{{item.statusText || item.status}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 家长专区（优化版） -->
  <view class="parent-section" wx:if="{{userType === 'parent' && children.length > 0}}">
    <view class="section-header">
      <text class="section-title">孩子学习情况</text>
      <text class="more-link" bindtap="onQuickActionTap" data-action="{{quickActions[0]}}">查看详情</text>
    </view>
    
    <view class="children-list">
      <view class="child-item" wx:for="{{children}}" wx:key="id" bindtap="viewChildDetail" data-id="{{item.id}}">
        <view class="child-avatar">
          <image src="{{item.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        </view>
        <view class="child-info">
          <text class="child-name">{{item.name}}</text>
          <text class="child-class">{{item.className}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.progressPercent}}%"></view>
          </view>
          <text class="child-progress">今日作业 {{item.todayHomework}}/{{item.totalHomework}}</text>
        </view>
        <view class="child-score">
          <text class="score-value">{{item.averageScore}}</text>
          <text class="score-label">平均分</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 新手引导 -->
<guide 
  wx:if="{{showGuide}}"
  show="{{showGuide}}"
  steps="{{guideSteps}}"
  current-step="{{guideStep}}"
  bind:next="nextGuideStep"
  bind:prev="prevGuideStep"
  bind:skip="skipGuide"
  bind:close="closeGuide"
/>

<!-- 加载状态 -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <t-icon name="loading" size="60rpx" color="#667eea"></t-icon>
    <text class="loading-text">加载中...</text>
  </view>
</view>