<!--pages/homework/homework.wxml-->
<view class="homework-container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="homework-header">
    <view class="stats-card">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{homeworkStats.total}}</text>
          <text class="stat-label">æ€»ä½œä¸š</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{homeworkStats.completed}}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{homeworkStats.avgScore}}</text>
          <text class="stat-label">å¹³å‡åˆ†</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{homeworkStats.accuracy}}%</text>
          <text class="stat-label">æ­£ç¡®ç‡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½å¯¼èˆª -->
  <view class="function-nav">
    <view class="nav-item {{activeTab === 'list' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="list">
      <text>ä½œä¸šåˆ—è¡¨</text>
    </view>
    <view class="nav-item {{activeTab === 'mistakes' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="mistakes">
      <text>é”™é¢˜æœ¬</text>
    </view>
    <view class="nav-item {{activeTab === 'analysis' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="analysis">
      <text>å­¦ä¹ åˆ†æ</text>
    </view>
  </view>

  <!-- ä½œä¸šåˆ—è¡¨ -->
  <view class="tab-content" wx:if="{{activeTab === 'list'}}">
    <!-- ç­›é€‰å™¨ -->
    <view class="filter-bar">
      <view class="filter-tabs">
        <view class="filter-tab {{statusFilter === 'all' ? 'active' : ''}}" 
              bindtap="switchStatusFilter" data-status="all">
          å…¨éƒ¨
        </view>
        <view class="filter-tab {{statusFilter === 'pending' ? 'active' : ''}}" 
              bindtap="switchStatusFilter" data-status="pending">
          å¾…å®Œæˆ
        </view>
        <view class="filter-tab {{statusFilter === 'completed' ? 'active' : ''}}" 
              bindtap="switchStatusFilter" data-status="completed">
          å·²å®Œæˆ
        </view>
        <view class="filter-tab {{statusFilter === 'overdue' ? 'active' : ''}}" 
              bindtap="switchStatusFilter" data-status="overdue">
          å·²é€¾æœŸ
        </view>
      </view>
    </view>

    <!-- ä½œä¸šåˆ—è¡¨ -->
    <view class="homework-list">
      <view class="homework-item" 
            wx:for="{{filteredHomework}}" 
            wx:key="id"
            bindtap="viewHomeworkDetail"
            data-homework="{{item}}">
        <view class="homework-header-info">
          <view class="homework-title">{{item.title}}</view>
          <view class="homework-status {{item.status}}">
            {{item.statusText}}
          </view>
        </view>
        <view class="homework-meta">
          <view class="meta-item">
            <text class="meta-label">ç§‘ç›®ï¼š</text>
            <text class="meta-value">{{item.subject}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">é¢˜ç›®ï¼š</text>
            <text class="meta-value">{{item.questionCount}}é¢˜</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">æˆªæ­¢ï¼š</text>
            <text class="meta-value">{{item.deadline}}</text>
          </view>
        </view>
        <view class="homework-progress" wx:if="{{item.status === 'completed'}}">
          <view class="progress-info">
            <text class="score">å¾—åˆ†ï¼š{{item.score}}/{{item.totalScore}}</text>
            <text class="accuracy">æ­£ç¡®ç‡ï¼š{{item.accuracy}}%</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" 
                  style="width: {{item.accuracy}}%"></view>
          </view>
        </view>
        <view class="homework-actions">
          <t-button 
            wx:if="{{item.status === 'pending'}}"
            size="small" 
            theme="primary"
            bindtap="startHomework"
            data-homework="{{item}}"
            catch:tap="true"
          >
            å¼€å§‹ä½œä¸š
          </t-button>
          <t-button 
            wx:if="{{item.status === 'completed'}}"
            size="small" 
            variant="outline"
            bindtap="viewHomeworkResult"
            data-homework="{{item}}"
            catch:tap="true"
          >
            æŸ¥çœ‹ç»“æœ
          </t-button>
          <t-button 
            wx:if="{{item.status === 'overdue'}}"
            size="small" 
            variant="outline"
            disabled
          >
            å·²é€¾æœŸ
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- é”™é¢˜æœ¬ -->
  <view class="tab-content" wx:if="{{activeTab === 'mistakes'}}">
    <!-- é”™é¢˜ç»Ÿè®¡ -->
    <view class="mistakes-stats">
      <view class="stats-card">
        <view class="stats-row">
          <view class="stat-item">
            <text class="stat-number">{{mistakeStats.total}}</text>
            <text class="stat-label">é”™é¢˜æ€»æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{mistakeStats.mastered}}</text>
            <text class="stat-label">å·²æŒæ¡</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{mistakeStats.reviewing}}</text>
            <text class="stat-label">å¤ä¹ ä¸­</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç§‘ç›®ç­›é€‰ -->
    <view class="subject-filter">
      <scroll-view class="subject-scroll" scroll-x="true">
        <view class="subject-item {{selectedSubject === 'all' ? 'active' : ''}}" 
              bindtap="selectSubject" data-subject="all">
          å…¨éƒ¨ç§‘ç›®
        </view>
        <view class="subject-item {{selectedSubject === item.id ? 'active' : ''}}" 
              wx:for="{{subjects}}" 
              wx:key="id"
              bindtap="selectSubject" 
              data-subject="{{item.id}}">
          {{item.name}}
        </view>
      </scroll-view>
    </view>

    <!-- é”™é¢˜åˆ—è¡¨ -->
    <view class="mistake-list">
      <view class="mistake-item" 
            wx:for="{{filteredMistakes}}" 
            wx:key="id"
            bindtap="viewMistakeDetail"
            data-mistake="{{item}}">
        <view class="mistake-header">
          <view class="mistake-subject">{{item.subject}}</view>
          <view class="mistake-status {{item.masteryLevel}}">
            {{item.masteryText}}
          </view>
        </view>
        <view class="mistake-content">
          <view class="question-text">{{item.questionText}}</view>
          <view class="mistake-info">
            <view class="info-item">
              <text class="info-label">é”™è¯¯æ¬¡æ•°ï¼š</text>
              <text class="info-value">{{item.mistakeCount}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æœ€è¿‘é”™è¯¯ï¼š</text>
              <text class="info-value">{{item.lastMistakeTime}}</text>
            </view>
          </view>
        </view>
        <view class="mistake-actions">
          <t-button 
            size="small" 
            theme="primary"
            bindtap="practiceAgain"
            data-mistake="{{item}}"
            catch:tap="true"
          >
            å†æ¬¡ç»ƒä¹ 
          </t-button>
          <t-button 
            size="small" 
            variant="outline"
            bindtap="viewExplanation"
            data-mistake="{{item}}"
            catch:tap="true"
          >
            æŸ¥çœ‹è§£æ
          </t-button>
        </view>
      </view>
    </view>
  </view>

  <!-- å­¦ä¹ åˆ†æ -->
  <view class="tab-content" wx:if="{{activeTab === 'analysis'}}">
    <!-- èƒ½åŠ›é›·è¾¾å›¾ -->
    <view class="analysis-section">
      <view class="section-title">
        <text class="title-text">ğŸ“Š èƒ½åŠ›åˆ†æ</text>
        <text class="title-desc">å„ç§‘ç›®æŒæ¡æƒ…å†µ</text>
      </view>
      <view class="radar-chart">
        <canvas canvas-id="radarChart" class="chart-canvas"></canvas>
      </view>
    </view>

    <!-- å­¦ä¹ è¶‹åŠ¿ -->
    <view class="analysis-section">
      <view class="section-title">
        <text class="title-text">ğŸ“ˆ å­¦ä¹ è¶‹åŠ¿</text>
        <text class="title-desc">æœ€è¿‘30å¤©è¡¨ç°</text>
      </view>
      <view class="trend-chart">
        <canvas canvas-id="trendChart" class="chart-canvas"></canvas>
      </view>
    </view>

    <!-- çŸ¥è¯†ç‚¹æŒæ¡ -->
    <view class="analysis-section">
      <view class="section-title">
        <text class="title-text">ğŸ¯ çŸ¥è¯†ç‚¹æŒæ¡</text>
        <text class="title-desc">è–„å¼±ç¯èŠ‚åˆ†æ</text>
      </view>
      <view class="knowledge-list">
        <view class="knowledge-item" 
              wx:for="{{knowledgePoints}}" 
              wx:key="id">
          <view class="knowledge-info">
            <view class="knowledge-name">{{item.name}}</view>
            <view class="knowledge-subject">{{item.subject}}</view>
          </view>
          <view class="knowledge-progress">
            <view class="progress-bar">
              <view class="progress-fill" 
                    style="width: {{item.mastery}}%; background-color: {{item.mastery >= 80 ? '#67c23a' : item.mastery >= 60 ? '#e6a23c' : '#f56c6c'}}"></view>
            </view>
            <text class="progress-text">{{item.mastery}}%</text>
          </view>
          <view class="knowledge-actions">
            <t-button 
              size="small" 
              variant="outline"
              bindtap="practiceKnowledge"
              data-knowledge="{{item}}"
            >
              ä¸“é¡¹ç»ƒä¹ 
            </t-button>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ å»ºè®® -->
    <view class="analysis-section">
      <view class="section-title">
        <text class="title-text">ğŸ’¡ å­¦ä¹ å»ºè®®</text>
        <text class="title-desc">AIæ™ºèƒ½æ¨è</text>
      </view>
      <view class="suggestion-list">
        <view class="suggestion-item" 
              wx:for="{{suggestions}}" 
              wx:key="id">
          <view class="suggestion-icon">{{item.icon}}</view>
          <view class="suggestion-content">
            <view class="suggestion-title">{{item.title}}</view>
            <view class="suggestion-desc">{{item.description}}</view>
          </view>
          <view class="suggestion-action">
            <t-button 
              size="small" 
              theme="primary"
              bindtap="applySuggestion"
              data-suggestion="{{item}}"
            >
              å»ç»ƒä¹ 
            </t-button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="large" text="åŠ è½½ä¸­..." />
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && isEmpty}}">
    <view class="empty-icon">ğŸ“</view>
    <view class="empty-text">æš‚æ— æ•°æ®</view>
  </view>
</view>

<!-- Toastæç¤º -->
<t-toast 
  visible="{{showToast}}"
  message="{{toastMessage}}"
  duration="{{2000}}"
  bind:close="onToastClose"
/>

<!-- ä½œä¸šè¯¦æƒ…å¼¹çª— -->
<t-popup 
  visible="{{showHomeworkDetail}}"
  placement="bottom"
  bind:visible-change="onHomeworkDetailClose"
>
  <view class="homework-detail-popup">
    <view class="popup-header">
      <view class="popup-title">ä½œä¸šè¯¦æƒ…</view>
      <view class="popup-close" bindtap="closeHomeworkDetail">Ã—</view>
    </view>
    <view class="popup-content" wx:if="{{selectedHomework}}">
      <view class="detail-info">
        <view class="detail-item">
          <text class="label">æ ‡é¢˜ï¼š</text>
          <text class="value">{{selectedHomework.title}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ç§‘ç›®ï¼š</text>
          <text class="value">{{selectedHomework.subject}}</text>
        </view>
        <view class="detail-item">
          <text class="label">é¢˜ç›®æ•°é‡ï¼š</text>
          <text class="value">{{selectedHomework.questionCount}}é¢˜</text>
        </view>
        <view class="detail-item">
          <text class="label">æˆªæ­¢æ—¶é—´ï¼š</text>
          <text class="value">{{selectedHomework.deadline}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedHomework.description}}">
          <text class="label">è¯´æ˜ï¼š</text>
          <text class="value">{{selectedHomework.description}}</text>
        </view>
      </view>
      <view class="detail-actions">
        <t-button 
          block 
          theme="primary" 
          disabled="{{selectedHomework.status !== 'pending'}}"
          bindtap="startSelectedHomework"
        >
          {{selectedHomework.status === 'pending' ? 'å¼€å§‹ä½œä¸š' : selectedHomework.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²é€¾æœŸ'}}
        </t-button>
      </view>
    </view>
  </view>
</t-popup>