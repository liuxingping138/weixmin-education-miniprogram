<!--pages/points/points.wxml-->
<view class="points-container">
  <!-- 顶部积分信息 -->
  <view class="points-header">
    <view class="points-card">
      <view class="points-info">
        <view class="current-points">
          <text class="points-number">{{userPoints.current}}</text>
          <text class="points-unit">积分</text>
        </view>
        <view class="points-desc">当前可用积分</view>
        <view class="level-info">
          <text class="level-badge">{{userPoints.levelName}}</text>
          <text class="level-text">Lv.{{userPoints.level}}</text>
        </view>
      </view>
      <view class="points-stats">
        <view class="stat-item">
          <text class="stat-number">{{userPoints.total}}</text>
          <text class="stat-label">累计获得</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{userPoints.used}}</text>
          <text class="stat-label">已使用</text>
        </view>
        <view class="stat-item" bindtap="viewRanking">
          <text class="stat-number">{{userPoints.rank}}</text>
          <text class="stat-label">班级排名</text>
        </view>
      </view>
      <view class="today-earned" wx:if="{{userPoints.todayEarned > 0}}">
        <text class="earned-text">今日已获得 {{userPoints.todayEarned}} 积分</text>
      </view>
    </view>
  </view>

  <!-- 功能导航 -->
  <view class="function-nav">
    <view class="nav-item {{activeTab === 'mall' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="mall">
      <text class="nav-icon">🛍️</text>
      <text class="nav-text">积分商城</text>
    </view>
    <view class="nav-item {{activeTab === 'tasks' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="tasks">
      <text class="nav-icon">📋</text>
      <text class="nav-text">任务中心</text>
    </view>
    <view class="nav-item {{activeTab === 'records' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="records">
      <text class="nav-icon">📊</text>
      <text class="nav-text">积分记录</text>
    </view>
    <view class="nav-item {{activeTab === 'ranking' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="ranking">
      <text class="nav-icon">🏆</text>
      <text class="nav-text">排行榜</text>
    </view>
  </view>

  <!-- 积分商城 -->
  <view class="tab-content" wx:if="{{activeTab === 'mall'}}">
    <!-- 商品分类 -->
    <view class="category-tabs">
      <scroll-view class="category-scroll" scroll-x="true">
        <view class="category-item {{selectedCategory === 'all' ? 'active' : ''}}" 
              bindtap="selectCategory" data-category="all">
          <text class="category-icon">📋</text>
          <text class="category-name">全部</text>
        </view>
        <view class="category-item {{selectedCategory === item.id ? 'active' : ''}}" 
              wx:for="{{categories}}" 
              wx:key="id"
              bindtap="selectCategory" 
              data-category="{{item.id}}">
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.name}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- 商品列表 -->
    <view class="goods-grid">
      <view class="goods-item" 
            wx:for="{{filteredGoods}}" 
            wx:key="id"
            bindtap="viewGoodsDetail"
            data-goods="{{item}}">
        <view class="goods-image">
          <image src="{{item.image}}" mode="aspectFill" />
          <view class="goods-badge hot" wx:if="{{item.isHot}}">🔥 热门</view>
          <view class="goods-badge new" wx:if="{{item.isNew}}">✨ 新品</view>
          <view class="goods-badge discount" wx:if="{{item.discount > 0}}">{{item.discount}}% OFF</view>
          <view class="goods-stock" wx:if="{{item.stock <= 10 && item.stock > 0}}">仅剩{{item.stock}}件</view>
          <view class="goods-sold-out" wx:if="{{item.stock === 0}}">已售罄</view>
        </view>
        <view class="goods-info">
          <view class="goods-name">{{item.name}}</view>
          <view class="goods-desc">{{item.description}}</view>
          <view class="goods-sales">已兑换 {{item.sales}} 件</view>
          <view class="goods-price">
            <view class="price-info">
              <text class="price-number">{{item.points}}</text>
              <text class="price-unit">积分</text>
              <text class="original-price" wx:if="{{item.originalPoints > item.points}}">{{item.originalPoints}}</text>
            </view>
            <view class="exchange-btn" 
                  class="{{item.stock === 0 || userPoints.current < item.points ? 'disabled' : ''}}"
                  bindtap="exchangeGoods"
                  data-goods="{{item}}"
                  catch:tap="true">
              {{item.stock === 0 ? '售罄' : userPoints.current < item.points ? '积分不足' : '兑换'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && filteredGoods.length === 0}}">
      <view class="empty-icon">🛍️</view>
      <view class="empty-text">暂无商品</view>
      <view class="empty-desc">敬请期待更多精彩商品</view>
    </view>
  </view>

  <!-- 任务中心 -->
  <view class="tab-content" wx:if="{{activeTab === 'tasks'}}">
    <!-- 每日任务 -->
    <view class="task-section">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">📅 每日任务</text>
          <text class="title-desc">完成任务获得积分奖励</text>
        </view>
        <view class="title-right">
          <text class="refresh-time">每日0点刷新</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item" 
              wx:for="{{dailyTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress" wx:if="{{item.type === 'progress'}}">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? '已完成' : item.canComplete ? '领取' : '未完成'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 周任务 -->
    <view class="task-section" wx:if="{{weeklyTasks.length > 0}}">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">📆 周任务</text>
          <text class="title-desc">挑战更高目标</text>
        </view>
        <view class="title-right">
          <text class="refresh-time">每周一刷新</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item weekly" 
              wx:for="{{weeklyTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? '已完成' : item.canComplete ? '领取' : Math.floor(item.progress / item.target * 100) + '%'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 成就任务 -->
    <view class="task-section">
      <view class="section-title">
        <view class="title-left">
          <text class="title-text">🏆 成就任务</text>
          <text class="title-desc">长期目标，丰厚奖励</text>
        </view>
      </view>
      <view class="task-list">
        <view class="task-item achievement {{item.difficulty}}" 
              wx:for="{{achievementTasks}}" 
              wx:key="id"
              class="{{item.completed ? 'completed' : ''}}">
          <view class="task-icon">{{item.icon}}</view>
          <view class="task-info">
            <view class="task-name">{{item.name}}</view>
            <view class="task-desc">{{item.description}}</view>
            <view class="task-progress">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{item.progress / item.target * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.progress}}/{{item.target}}</text>
            </view>
            <view class="difficulty-badge {{item.difficulty}}">
              {{item.difficulty === 'easy' ? '简单' : item.difficulty === 'medium' ? '中等' : '困难'}}
            </view>
          </view>
          <view class="task-reward">
            <text class="reward-points">+{{item.points}}</text>
            <view class="task-btn" 
                  class="{{item.completed ? 'completed' : item.canComplete ? 'can-complete' : 'disabled'}}"
                  bindtap="completeTask"
                  data-task="{{item}}">
              {{item.completed ? '已完成' : item.canComplete ? '领取' : Math.floor(item.progress / item.target * 100) + '%'}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 积分记录 -->
  <view class="tab-content" wx:if="{{activeTab === 'records'}}">
    <!-- 筛选器 -->
    <view class="record-filters">
      <view class="filter-tabs">
        <view class="filter-tab {{recordType === 'all' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="all">
          <text class="filter-icon">📋</text>
          <text class="filter-text">全部</text>
        </view>
        <view class="filter-tab {{recordType === 'earn' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="earn">
          <text class="filter-icon">📈</text>
          <text class="filter-text">获得</text>
        </view>
        <view class="filter-tab {{recordType === 'spend' ? 'active' : ''}}" 
              bindtap="switchRecordType" data-type="spend">
          <text class="filter-icon">📉</text>
          <text class="filter-text">消费</text>
        </view>
      </view>
    </view>

    <!-- 记录列表 -->
    <view class="record-list">
      <view class="record-item" 
            wx:for="{{filteredRecords}}" 
            wx:key="id">
        <view class="record-icon {{item.type}}">
          <text class="icon-text">{{item.icon}}</text>
        </view>
        <view class="record-info">
          <view class="record-title">{{item.title}}</view>
          <view class="record-desc">{{item.description}}</view>
          <view class="record-time">{{item.createTime}}</view>
        </view>
        <view class="record-points">
          <text class="points-change {{item.type === 'earn' ? 'earn' : 'spend'}}">
            {{item.type === 'earn' ? '+' : '-'}}{{item.points}}
          </text>
          <text class="points-unit">积分</text>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
      <view class="empty-icon">📊</view>
      <view class="empty-text">暂无记录</view>
      <view class="empty-desc">完成任务或兑换商品后会显示记录</view>
    </view>
  </view>

  <!-- 排行榜 -->
  <view class="tab-content" wx:if="{{activeTab === 'ranking'}}">
    <!-- 我的排名 -->
    <view class="my-ranking" wx:if="{{myRanking}}">
      <view class="ranking-title">我的排名</view>
      <view class="ranking-item my-rank">
        <view class="rank-number">{{myRanking.rank}}</view>
        <view class="user-avatar">
          <image src="{{myRanking.avatar}}" mode="aspectFill" />
        </view>
        <view class="user-info">
          <view class="user-name">{{myRanking.name}}</view>
          <view class="user-level">{{myRanking.levelName}} Lv.{{myRanking.level}}</view>
        </view>
        <view class="user-points">
          <text class="points-number">{{myRanking.points}}</text>
          <text class="points-unit">积分</text>
          <view class="weekly-increase">
            <text class="increase-text">周增长 +{{myRanking.weeklyIncrease}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 排行榜列表 -->
    <view class="ranking-list">
      <view class="ranking-title">积分排行榜</view>
      <view class="ranking-item" 
            wx:for="{{rankingList}}" 
            wx:key="id"
            class="{{item.isMe ? 'is-me' : ''}}">
        <view class="rank-number {{item.rank <= 3 ? 'top-three' : ''}}" 
              data-rank="{{item.rank}}">
          <text wx:if="{{item.rank === 1}}">🥇</text>
          <text wx:elif="{{item.rank === 2}}">🥈</text>
          <text wx:elif="{{item.rank === 3}}">🥉</text>
          <text wx:else>{{item.rank}}</text>
        </view>
        <view class="user-avatar">
          <image src="{{item.avatar}}" mode="aspectFill" />
          <view class="level-badge">{{item.level}}</view>
        </view>
        <view class="user-info">
          <view class="user-name">{{item.name}}</view>
          <view class="user-level">{{item.levelName}}</view>
        </view>
        <view class="user-points">
          <text class="points-number">{{item.points}}</text>
          <text class="points-unit">积分</text>
          <view class="weekly-increase" wx:if="{{item.weeklyIncrease > 0}}">
            <text class="increase-text">+{{item.weeklyIncrease}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && rankingList.length === 0}}">
      <view class="empty-icon">🏆</view>
      <view class="empty-text">暂无排行数据</view>
      <view class="empty-desc">努力学习，争取上榜吧！</view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- Toast提示 -->
<view class="toast-container" wx:if="{{showToast}}">
  <view class="toast-message">{{toastMessage}}</view>
</view>

<!-- 商品详情弹窗 -->
<view class="popup-overlay" wx:if="{{showGoodsDetail}}" bindtap="closeGoodsDetail">
  <view class="goods-detail-popup" catch:tap="true">
    <view class="popup-header">
      <view class="popup-title">商品详情</view>
      <view class="popup-close" bindtap="closeGoodsDetail">×</view>
    </view>
    <view class="popup-content" wx:if="{{selectedGoods}}">
      <view class="detail-image">
        <image src="{{selectedGoods.image}}" mode="aspectFill" />
        <view class="image-badges">
          <view class="badge hot" wx:if="{{selectedGoods.isHot}}">🔥 热门</view>
          <view class="badge new" wx:if="{{selectedGoods.isNew}}">✨ 新品</view>
          <view class="badge discount" wx:if="{{selectedGoods.discount > 0}}">{{selectedGoods.discount}}% OFF</view>
        </view>
      </view>
      <view class="detail-info">
        <view class="detail-name">{{selectedGoods.name}}</view>
        <view class="detail-desc">{{selectedGoods.description}}</view>
        <view class="detail-meta">
          <view class="meta-item">
            <text class="meta-label">库存：</text>
            <text class="meta-value">{{selectedGoods.stock}}件</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">已兑换：</text>
            <text class="meta-value">{{selectedGoods.sales}}件</text>
          </view>
        </view>
        <view class="detail-price">
          <text class="price-number">{{selectedGoods.points}}</text>
          <text class="price-unit">积分</text>
          <text class="original-price" wx:if="{{selectedGoods.originalPoints > selectedGoods.points}}">原价 {{selectedGoods.originalPoints}} 积分</text>
        </view>
      </view>
      <view class="detail-actions">
        <button 
          class="exchange-button {{selectedGoods.stock === 0 || userPoints.current < selectedGoods.points ? 'disabled' : ''}}"
          disabled="{{selectedGoods.stock === 0 || userPoints.current < selectedGoods.points}}"
          bindtap="confirmExchange"
        >
          {{selectedGoods.stock === 0 ? '已售罄' : userPoints.current < selectedGoods.points ? '积分不足' : '确认兑换'}}
        </button>
      </view>
    </view>
  </view>
</view>

<!-- 升级弹窗 -->
<view class="popup-overlay" wx:if="{{showLevelUpModal}}" bindtap="closeLevelUpModal">
  <view class="level-up-popup" catch:tap="true">
    <view class="level-up-content">
      <view class="level-up-icon">🎉</view>
      <view class="level-up-title">恭喜升级！</view>
      <view class="level-progress">
        <view class="old-level">
          <text class="level-name">{{levelUpInfo.oldLevelName}}</text>
          <text class="level-number">Lv.{{levelUpInfo.oldLevel}}</text>
        </view>
        <view class="level-arrow">→</view>
        <view class="new-level">
          <text class="level-name">{{levelUpInfo.newLevelName}}</text>
          <text class="level-number">Lv.{{levelUpInfo.newLevel}}</text>
        </view>
      </view>
      <view class="level-rewards">
        <view class="rewards-title">升级奖励</view>
        <view class="rewards-list">
          <view class="reward-item" wx:for="{{levelUpInfo.rewards}}" wx:key="*this">
            <text class="reward-text">{{item}}</text>
          </view>
        </view>
      </view>
      <button class="level-up-btn" bindtap="closeLevelUpModal">太棒了！</button>
    </view>
  </view>
</view>