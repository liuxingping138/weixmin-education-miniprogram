<!--pages/practice/practice.wxml-->
<view class="practice-container">
  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="加载中..." />
  
  <!-- 顶部功能介绍 -->
  <view class="practice-header">
    <view class="header-content">
      <view class="title">智能练习</view>
      <view class="subtitle">AI个性化推荐，精准提升学习效果</view>
    </view>
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{practiceStats.totalCount}}</text>
        <text class="stat-label">累计练习</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{practiceStats.accuracy}}%</text>
        <text class="stat-label">正确率</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{practiceStats.streak}}</text>
        <text class="stat-label">连续天数</text>
      </view>
    </view>
  </view>

  <!-- 功能导航 -->
  <view class="practice-nav">
    <view 
      class="nav-item {{activeTab === 'recommend' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="recommend"
    >
      <text>AI推荐</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'subject' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="subject"
    >
      <text>学科练习</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'exam' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="exam"
    >
      <text>模拟考试</text>
    </view>
    <view 
      class="nav-item {{activeTab === 'history' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="history"
    >
      <text>练习记录</text>
    </view>
  </view>

  <!-- 标签页内容 -->
  <view class="tab-content">
    <!-- AI推荐练习 -->
    <view wx:if="{{activeTab === 'recommend'}}" class="recommend-content">
      <!-- 推荐理由 -->
      <view class="recommend-reason">
        <view class="reason-title">为你推荐</view>
        <view class="reason-text">{{recommendReason}}</view>
      </view>

      <!-- 推荐练习列表 -->
      <view class="practice-list">
        <view 
          wx:for="{{recommendPractices}}"
          wx:key="id"
          class="practice-card"
          bindtap="startPractice"
          data-practice="{{item}}"
        >
          <view class="card-header">
            <view class="subject-tag {{item.subject}}">{{item.subjectName}}</view>
            <view class="difficulty-tag {{item.difficulty}}">{{item.difficultyText}}</view>
          </view>
          <view class="card-title">{{item.title}}</view>
          <view class="card-desc">{{item.description}}</view>
          <view class="card-stats">
            <text class="stat">{{item.questionCount}}题</text>
            <text class="stat">预计{{item.duration}}分钟</text>
            <text class="stat accuracy">推荐度{{item.matchScore}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 学科练习 -->
    <view wx:if="{{activeTab === 'subject'}}" class="subject-content">
      <!-- 学科选择 -->
      <view class="subject-selector">
        <view 
          wx:for="{{subjects}}"
          wx:key="id"
          class="subject-item {{selectedSubject === item.id ? 'selected' : ''}}"
          bindtap="selectSubject"
          data-subject="{{item.id}}"
        >
          <view class="subject-icon {{item.id}}"></view>
          <text class="subject-name">{{item.name}}</text>
        </view>
      </view>

      <!-- 知识点选择 -->
      <view class="knowledge-points" wx:if="{{selectedSubject}}">
        <view class="section-title">选择知识点</view>
        <view class="points-grid">
          <view 
            wx:for="{{knowledgePoints}}"
            wx:key="id"
            class="point-item {{item.mastery}}"
            bindtap="selectKnowledgePoint"
            data-point="{{item.id}}"
          >
            <text class="point-name">{{item.name}}</text>
            <text class="mastery-rate">{{item.masteryRate}}%</text>
          </view>
        </view>
      </view>

      <!-- 练习设置 -->
      <view class="practice-settings" wx:if="{{selectedKnowledgePoints.length > 0}}">
        <view class="section-title">练习设置</view>
        <view class="setting-item">
          <text class="setting-label">题目数量</text>
          <view class="quantity-selector">
            <view 
              wx:for="{{[10, 20, 30, 50]}}"
              wx:key="*this"
              class="quantity-option {{questionCount === item ? 'selected' : ''}}"
              bindtap="selectQuestionCount"
              data-count="{{item}}"
            >
              {{item}}题
            </view>
          </view>
        </view>
        <view class="setting-item">
          <text class="setting-label">难度等级</text>
          <view class="difficulty-selector">
            <view 
              wx:for="{{difficulties}}"
              wx:key="id"
              class="difficulty-option {{selectedDifficulty === item.id ? 'selected' : ''}}"
              bindtap="selectDifficulty"
              data-difficulty="{{item.id}}"
            >
              {{item.name}}
            </view>
          </view>
        </view>
        <t-button 
          theme="primary" 
          size="large" 
          class="start-practice-btn"
          bindtap="startCustomPractice"
        >
          开始练习
        </t-button>
      </view>
    </view>

    <!-- 模拟考试 -->
    <view wx:if="{{activeTab === 'exam'}}" class="exam-content">
      <view class="exam-list">
        <view 
          wx:for="{{examPapers}}"
          wx:key="id"
          class="exam-card"
          bindtap="startExam"
          data-exam="{{item}}"
        >
          <view class="exam-header">
            <view class="exam-title">{{item.title}}</view>
            <view class="exam-type">{{item.type}}</view>
          </view>
          <view class="exam-info">
            <text class="info-item">{{item.questionCount}}题</text>
            <text class="info-item">{{item.duration}}分钟</text>
            <text class="info-item">{{item.totalScore}}分</text>
          </view>
          <view class="exam-desc">{{item.description}}</view>
          <view class="exam-stats" wx:if="{{item.bestScore}}">
            <text class="best-score">最佳成绩：{{item.bestScore}}分</text>
            <text class="attempt-count">已考{{item.attemptCount}}次</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 练习记录 -->
    <view wx:if="{{activeTab === 'history'}}" class="history-content">
      <!-- 筛选器 -->
      <view class="history-filter">
        <view class="filter-item">
          <text class="filter-label">时间范围</text>
          <picker 
            mode="selector" 
            range="{{timeRanges}}" 
            range-key="name"
            value="{{selectedTimeRange}}"
            bindchange="onTimeRangeChange"
          >
            <view class="picker-value">{{timeRanges[selectedTimeRange].name}}</view>
          </picker>
        </view>
        <view class="filter-item">
          <text class="filter-label">学科</text>
          <picker 
            mode="selector" 
            range="{{subjectFilter}}" 
            range-key="name"
            value="{{selectedSubjectFilter}}"
            bindchange="onSubjectFilterChange"
          >
            <view class="picker-value">{{subjectFilter[selectedSubjectFilter].name}}</view>
          </picker>
        </view>
      </view>

      <!-- 练习记录列表 -->
      <view class="history-list">
        <view 
          wx:for="{{practiceHistory}}"
          wx:key="id"
          class="history-item"
          bindtap="viewPracticeDetail"
          data-practice="{{item}}"
        >
          <view class="history-header">
            <view class="practice-title">{{item.title}}</view>
            <view class="practice-date">{{item.createTime}}</view>
          </view>
          <view class="history-stats">
            <view class="stat-group">
              <text class="stat-label">正确率</text>
              <text class="stat-value accuracy">{{item.accuracy}}%</text>
            </view>
            <view class="stat-group">
              <text class="stat-label">用时</text>
              <text class="stat-value">{{item.duration}}</text>
            </view>
            <view class="stat-group">
              <text class="stat-label">得分</text>
              <text class="stat-value score">{{item.score}}</text>
            </view>
          </view>
          <view class="history-tags">
            <text class="subject-tag {{item.subject}}">{{item.subjectName}}</text>
            <text class="type-tag">{{item.type}}</text>
          </view>
        </view>
      </view>

      <!-- 加载更多 -->
      <view class="load-more" wx:if="{{hasMoreHistory}}">
        <t-button 
          theme="light" 
          size="medium" 
          loading="{{loadingMore}}"
          bindtap="loadMoreHistory"
        >
          {{loadingMore ? '加载中...' : '加载更多'}}
        </t-button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <t-empty 
    wx:if="{{!loading && isEmpty}}"
    icon="search"
    description="暂无练习数据"
  >
    <t-button slot="action" theme="primary" size="medium" bindtap="refreshData">
      刷新数据
    </t-button>
  </t-empty>

  <!-- Toast提示 -->
  <t-toast id="t-toast" />
</view>