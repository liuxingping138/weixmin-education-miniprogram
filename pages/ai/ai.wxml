<!--pages/ai/ai.wxml-->
<view class="ai-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <loading-state wx:if="{{loading}}" />
  
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="ai-header">
    <view class="header-title">
      <text class="title-icon">ğŸ¤–</text>
      <text class="title-text">AIæ™ºèƒ½åŠ©æ‰‹</text>
    </view>
    <view class="header-subtitle">ä¸ªæ€§åŒ–å­¦ä¹ ï¼Œæ™ºèƒ½åŒ–æå‡</view>
  </view>

  <!-- AIç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-icon">ğŸ“Š</view>
        <view class="stat-value">{{aiStats.totalQuestions}}</view>
        <view class="stat-label">ç”Ÿæˆé¢˜ç›®</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">ğŸ’¡</view>
        <view class="stat-value">{{aiStats.recommendations}}</view>
        <view class="stat-label">æ™ºèƒ½æ¨è</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">ğŸ¯</view>
        <view class="stat-value">{{aiStats.accuracy}}%</view>
        <view class="stat-label">å‡†ç¡®ç‡</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">ğŸ“…</view>
        <view class="stat-value">{{aiStats.studyDays}}</view>
        <view class="stat-label">å­¦ä¹ å¤©æ•°</view>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view 
      class="tab-item {{activeTab === 'generate' ? 'active' : ''}}"
      data-tab="generate"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ²</text>
      <text class="tab-text">æ™ºèƒ½å‡ºé¢˜</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'recommend' ? 'active' : ''}}"
      data-tab="recommend"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ’¡</text>
      <text class="tab-text">ä¸ªæ€§æ¨è</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'analysis' ? 'active' : ''}}"
      data-tab="analysis"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ“ˆ</text>
      <text class="tab-text">å­¦ä¹ åˆ†æ</text>
    </view>
  </view>

  <!-- æ™ºèƒ½å‡ºé¢˜é¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'generate'}}">
    <!-- ç§‘ç›®é€‰æ‹© -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ“š</text>
        <text class="title-text">é€‰æ‹©ç§‘ç›®</text>
      </view>
      <view class="subject-grid">
        <view 
          wx:for="{{subjects}}" 
          wx:key="id"
          class="subject-item {{selectedSubject === item.id ? 'selected' : ''}}"
          data-subject="{{item.id}}"
          bindtap="selectSubject"
          style="border-color: {{item.color}}"
        >
          <view class="subject-icon" style="background-color: {{item.color}}20">{{item.icon}}</view>
          <view class="subject-name">{{item.name}}</view>
        </view>
      </view>
    </view>

    <!-- çŸ¥è¯†ç‚¹é€‰æ‹© -->
    <view class="section" wx:if="{{knowledgePoints.length > 0}}">
      <view class="section-title">
        <text class="title-icon">ğŸ¯</text>
        <text class="title-text">é€‰æ‹©çŸ¥è¯†ç‚¹ï¼ˆå¯é€‰ï¼‰</text>
      </view>
      <view class="knowledge-list">
        <view 
          wx:for="{{knowledgePoints}}" 
          wx:key="id"
          class="knowledge-item {{item.selected ? 'selected' : ''}}"
          data-knowledge="{{item.id}}"
          bindtap="toggleKnowledge"
        >
          <view class="knowledge-checkbox">
            <text class="checkbox-icon" wx:if="{{item.selected}}">âœ“</text>
          </view>
          <view class="knowledge-info">
            <view class="knowledge-name">{{item.name}}</view>
            <view class="knowledge-difficulty">{{item.difficulty === 'easy' ? 'ç®€å•' : item.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾'}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- éš¾åº¦é€‰æ‹© -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">âš¡</text>
        <text class="title-text">é€‰æ‹©éš¾åº¦</text>
      </view>
      <view class="difficulty-list">
        <view 
          wx:for="{{difficulties}}" 
          wx:key="value"
          class="difficulty-item {{selectedDifficulty === item.value ? 'selected' : ''}}"
          data-difficulty="{{item.value}}"
          bindtap="selectDifficulty"
          style="border-color: {{item.color}}"
        >
          <view class="difficulty-icon">{{item.icon}}</view>
          <view class="difficulty-name">{{item.name}}</view>
        </view>
      </view>
    </view>

    <!-- é¢˜ç›®æ•°é‡ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ”¢</text>
        <text class="title-text">é¢˜ç›®æ•°é‡</text>
      </view>
      <view class="quantity-selector">
        <view class="quantity-btn" bindtap="decreaseQuantity">-</view>
        <view class="quantity-value">{{questionQuantity}}</view>
        <view class="quantity-btn" bindtap="increaseQuantity">+</view>
      </view>
    </view>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <view class="generate-section">
      <button 
        class="generate-btn {{generating ? 'generating' : ''}}"
        bindtap="generateQuestions"
        disabled="{{generating}}"
      >
        <text wx:if="{{!generating}}">ğŸ² AIæ™ºèƒ½ç”Ÿæˆé¢˜ç›®</text>
        <text wx:else>ğŸ¤– AIæ­£åœ¨ç”Ÿæˆä¸­...</text>
      </button>
    </view>

    <!-- ç”Ÿæˆçš„é¢˜ç›®åˆ—è¡¨ -->
    <view class="generated-section" wx:if="{{generatedQuestions.length > 0}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“</text>
        <text class="title-text">ç”Ÿæˆçš„é¢˜ç›® ({{generatedQuestions.length}}é“)</text>
      </view>
      
      <view class="question-actions">
        <button class="action-btn primary" bindtap="startPractice">å¼€å§‹ç»ƒä¹ </button>
        <button class="action-btn secondary" bindtap="saveQuestions">ä¿å­˜é¢˜ç›®</button>
        <button class="action-btn tertiary" bindtap="regenerateQuestions">é‡æ–°ç”Ÿæˆ</button>
      </view>

      <view class="question-list">
        <view 
          wx:for="{{generatedQuestions}}" 
          wx:key="id"
          class="question-item"
          data-question="{{item}}"
          bindtap="viewQuestionDetail"
        >
          <view class="question-header">
            <view class="question-number">ç¬¬{{item.id}}é¢˜</view>
            <view class="question-difficulty" style="color: {{item.difficultyColor}}">
              {{item.difficultyText}}
            </view>
            <view class="question-time">{{item.estimatedTime}}åˆ†é’Ÿ</view>
          </view>
          <view class="question-content">{{item.question}}</view>
          <view class="question-meta">
            <view class="question-knowledge">{{item.knowledgePoint}}</view>
            <view class="question-ai-score">AIè¯„åˆ†: {{item.aiScore}}</view>
          </view>
          <view class="question-tags">
            <text 
              wx:for="{{item.tags}}" 
              wx:for-item="tag"
              wx:key="*this"
              class="question-tag"
            >{{tag}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¸ªæ€§æ¨èé¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'recommend'}}">
    <!-- ä»Šæ—¥æ¨èæ¦‚è§ˆ -->
    <view class="today-overview">
      <view class="overview-title">ä»Šæ—¥æ¨è</view>
      <view class="overview-stats">
        <view class="overview-item">
          <view class="overview-number">{{todayRecommendations.length}}</view>
          <view class="overview-label">å¾…å®Œæˆ</view>
        </view>
        <view class="overview-item">
          <view class="overview-number">{{completedRecommendations}}</view>
          <view class="overview-label">å·²å®Œæˆ</view>
        </view>
      </view>
    </view>

    <!-- æ¨èåˆ†ç±»ç­›é€‰ -->
    <view class="category-filter">
      <scroll-view class="category-scroll" scroll-x="true">
        <view class="category-list">
          <view 
            class="category-item {{selectedCategory === 'all' ? 'active' : ''}}"
            data-category="all"
            bindtap="selectCategory"
          >
            <text class="category-icon">ğŸ“‹</text>
            <text class="category-name">å…¨éƒ¨</text>
          </view>
          <view 
            wx:for="{{recommendCategories}}" 
            wx:key="id"
            class="category-item {{selectedCategory === item.id ? 'active' : ''}}"
            data-category="{{item.id}}"
            bindtap="selectCategory"
          >
            <text class="category-icon">{{item.icon}}</text>
            <text class="category-name">{{item.name}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- æ¨èåˆ—è¡¨ -->
    <view class="recommend-list">
      <view 
        wx:for="{{filteredRecommendations}}" 
        wx:key="id"
        class="recommend-item {{item.completed ? 'completed' : ''}}"
        data-recommendation="{{item}}"
        bindtap="viewRecommendation"
      >
        <view class="recommend-header">
          <view class="recommend-icon">{{item.icon}}</view>
          <view class="recommend-info">
            <view class="recommend-title">{{item.title}}</view>
            <view class="recommend-reason">{{item.reason}}</view>
          </view>
          <view class="recommend-priority {{item.priority}}">
            {{item.priorityText}}
          </view>
        </view>
        
        <view class="recommend-content">
          <view class="recommend-description">{{item.description}}</view>
          <view class="recommend-meta">
            <view class="meta-item">
              <text class="meta-icon">â±ï¸</text>
              <text class="meta-text">{{item.estimatedTime}}åˆ†é’Ÿ</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">ğŸ¯</text>
              <text class="meta-text">{{item.subject}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">ğŸ¤–</text>
              <text class="meta-text">AIè¯„åˆ†{{item.aiScore}}</text>
            </view>
          </view>
        </view>

        <view class="recommend-progress" wx:if="{{item.progress > 0}}">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.progress}}%"></view>
          </view>
          <view class="progress-text">{{item.progress}}%</view>
        </view>

        <view class="recommend-actions">
          <button 
            class="action-btn {{item.completed ? 'completed' : 'primary'}}"
            data-recommendation="{{item}}"
            bindtap="startRecommendation"
            disabled="{{item.completed}}"
          >
            {{item.completed ? 'å·²å®Œæˆ' : 'å¼€å§‹å­¦ä¹ '}}
          </button>
          <button 
            class="action-btn secondary"
            data-recommendation="{{item}}"
            bindtap="postponeRecommendation"
            wx:if="{{!item.completed}}"
          >
            æ¨è¿Ÿ
          </button>
        </view>

        <view class="recommend-tags">
          <text 
            wx:for="{{item.tags}}" 
            wx:for-item="tag"
            wx:key="*this"
            class="recommend-tag"
          >{{tag}}</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <empty-state 
      wx:if="{{filteredRecommendations.length === 0 && !loading}}"
      icon="ğŸ’¡"
      title="æš‚æ— æ¨è"
      description="AIæ­£åœ¨åˆ†ææ‚¨çš„å­¦ä¹ æƒ…å†µï¼Œç¨åä¼šä¸ºæ‚¨æ¨èåˆé€‚çš„å­¦ä¹ å†…å®¹"
    />
  </view>

  <!-- å­¦ä¹ åˆ†æé¡µé¢ -->
  <view class="tab-content" wx:if="{{activeTab === 'analysis'}}">
    <!-- åˆ†ææ—¥æœŸ -->
    <view class="analysis-date">
      <text class="date-icon">ğŸ“…</text>
      <text class="date-text">åˆ†ææ—¥æœŸï¼š{{analysisDate}}</text>
    </view>

    <!-- å­¦ä¹ çŠ¶æ€è¯„ä¼° -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">å­¦ä¹ çŠ¶æ€è¯„ä¼°</text>
      </view>
      <view class="status-grid">
        <view 
          wx:for="{{learningStatus}}" 
          wx:key="type"
          class="status-item"
        >
          <view class="status-icon">{{item.icon}}</view>
          <view class="status-info">
            <view class="status-name">{{item.name}}</view>
            <view class="status-score">{{item.score}}åˆ†</view>
            <view class="status-description">{{item.description}}</view>
          </view>
          <view class="status-progress">
            <view class="progress-circle">
              <view class="progress-text">{{item.score}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜åŠ¿ä¸ä¸è¶³ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">âš–ï¸</text>
        <text class="title-text">ä¼˜åŠ¿ä¸ä¸è¶³</text>
      </view>
      
      <view class="strengths-weaknesses">
        <view class="strengths">
          <view class="sw-title">
            <text class="sw-icon">ğŸ’ª</text>
            <text class="sw-text">å­¦ä¹ ä¼˜åŠ¿</text>
          </view>
          <view class="sw-list">
            <view 
              wx:for="{{strengths}}" 
              wx:key="*this"
              class="sw-item strength"
            >
              <text class="sw-bullet">âœ“</text>
              <text class="sw-content">{{item}}</text>
            </view>
          </view>
        </view>
        
        <view class="weaknesses">
          <view class="sw-title">
            <text class="sw-icon">âš ï¸</text>
            <text class="sw-text">å¾…æ”¹è¿›é¡¹</text>
          </view>
          <view class="sw-list">
            <view 
              wx:for="{{weaknesses}}" 
              wx:key="*this"
              class="sw-item weakness"
            >
              <text class="sw-bullet">!</text>
              <text class="sw-content">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- AIæ™ºèƒ½å»ºè®® -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ¤–</text>
        <text class="title-text">AIæ™ºèƒ½å»ºè®®</text>
      </view>
      <view class="suggestions-list">
        <view 
          wx:for="{{aiSuggestions}}" 
          wx:key="id"
          class="suggestion-item"
        >
          <view class="suggestion-header">
            <view class="suggestion-icon">{{item.icon}}</view>
            <view class="suggestion-info">
              <view class="suggestion-title">{{item.title}}</view>
              <view class="suggestion-priority {{item.priority}}">
                {{item.priorityText}}
              </view>
            </view>
            <view class="suggestion-confidence">
              <text class="confidence-text">å¯ä¿¡åº¦</text>
              <text class="confidence-value">{{item.aiConfidence}}%</text>
            </view>
          </view>
          
          <view class="suggestion-content">{{item.content}}</view>
          
          <view class="suggestion-meta">
            <view class="meta-item">
              <text class="meta-icon">ğŸ“ˆ</text>
              <text class="meta-text">é¢„æœŸæå‡{{item.estimatedEffect}}%</text>
            </view>
          </view>
          
          <view class="suggestion-actions">
            <button 
              class="action-btn primary"
              data-suggestion="{{item}}"
              bindtap="applySuggestion"
            >
              åº”ç”¨å»ºè®®
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ è¶‹åŠ¿å›¾è¡¨å ä½ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ“ˆ</text>
        <text class="title-text">å­¦ä¹ è¶‹åŠ¿</text>
      </view>
      <view class="chart-placeholder">
        <text class="chart-text">ğŸ“Š å­¦ä¹ è¶‹åŠ¿å›¾è¡¨</text>
        <text class="chart-desc">æ˜¾ç¤ºæœ€è¿‘30å¤©çš„å­¦ä¹ æ•°æ®å˜åŒ–</text>
      </view>
    </view>
  </view>

  <!-- æ¨èè¯¦æƒ…å¼¹çª— -->
  <t-popup
    visible="{{showRecommendDetail}}"
    placement="bottom"
    bind:visible-change="onRecommendDetailClose"
  >
    <view class="recommend-detail" wx:if="{{selectedRecommendation}}">
      <view class="detail-header">
        <view class="detail-icon">{{selectedRecommendation.icon}}</view>
        <view class="detail-title">{{selectedRecommendation.title}}</view>
        <view class="detail-close" bindtap="closeRecommendDetail">Ã—</view>
      </view>
      
      <view class="detail-content">
        <view class="detail-section">
          <view class="detail-label">æ¨èåŸå› </view>
          <view class="detail-text">{{selectedRecommendation.reason}}</view>
        </view>
        
        <view class="detail-section">
          <view class="detail-label">å­¦ä¹ ç›®æ ‡</view>
          <view class="detail-text">{{selectedRecommendation.goal}}</view>
        </view>
        
        <view class="detail-section">
          <view class="detail-label">é¢„æœŸæ”¶ç›Š</view>
          <view class="detail-text">{{selectedRecommendation.benefit}}</view>
        </view>
        
        <view class="detail-meta">
          <view class="meta-row">
            <view class="meta-item">
              <text class="meta-label">ç§‘ç›®ï¼š</text>
              <text class="meta-value">{{selectedRecommendation.subject}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-label">çŸ¥è¯†ç‚¹ï¼š</text>
              <text class="meta-value">{{selectedRecommendation.knowledgePoint}}</text>
            </view>
          </view>
          <view class="meta-row">
            <view class="meta-item">
              <text class="meta-label">é¢„è®¡æ—¶é—´ï¼š</text>
              <text class="meta-value">{{selectedRecommendation.estimatedTime}}åˆ†é’Ÿ</text>
            </view>
            <view class="meta-item">
              <text class="meta-label">AIè¯„åˆ†ï¼š</text>
              <text class="meta-value">{{selectedRecommendation.aiScore}}åˆ†</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="detail-actions">
        <button 
          class="detail-btn primary"
          bindtap="startSelectedRecommendation"
          disabled="{{selectedRecommendation.completed}}"
        >
          {{selectedRecommendation.completed ? 'å·²å®Œæˆ' : 'å¼€å§‹å­¦ä¹ '}}
        </button>
      </view>
    </view>
  </t-popup>

  <!-- é¢˜ç›®è¯¦æƒ…å¼¹çª— -->
  <t-popup
    visible="{{showQuestionDetail}}"
    placement="bottom"
    bind:visible-change="onQuestionDetailClose"
  >
    <view class="question-detail" wx:if="{{selectedQuestion}}">
      <view class="detail-header">
        <view class="detail-title">é¢˜ç›®è¯¦æƒ…</view>
        <view class="detail-close" bindtap="closeQuestionDetail">Ã—</view>
      </view>
      
      <view class="detail-content">
        <view class="question-info">
          <view class="question-number">ç¬¬{{selectedQuestion.id}}é¢˜</view>
          <view class="question-difficulty" style="color: {{selectedQuestion.difficultyColor}}">
            {{selectedQuestion.difficultyText}}
          </view>
        </view>
        
        <view class="question-text">{{selectedQuestion.question}}</view>
        
        <view class="question-options" wx:if="{{selectedQuestion.type === 'choice'}}">
          <view 
            wx:for="{{selectedQuestion.options}}" 
            wx:key="*this"
            class="option-item"
          >{{item}}</view>
        </view>
        
        <view class="question-explanation">
          <view class="explanation-title">é¢˜ç›®è§£æ</view>
          <view class="explanation-text">{{selectedQuestion.explanation}}</view>
        </view>
        
        <view class="question-meta">
          <view class="meta-item">
            <text class="meta-label">çŸ¥è¯†ç‚¹ï¼š</text>
            <text class="meta-value">{{selectedQuestion.knowledgePoint}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">é¢„è®¡ç”¨æ—¶ï¼š</text>
            <text class="meta-value">{{selectedQuestion.estimatedTime}}åˆ†é’Ÿ</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">ç›¸å…³é¢˜ç›®ï¼š</text>
            <text class="meta-value">{{selectedQuestion.relatedQuestions}}é“</text>
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- Toastæç¤º -->
  <t-toast
    visible="{{showToast}}"
    message="{{toastMessage}}"
    bind:close="onToastClose"
  />
</view>